<?xml version="1.0" encoding="UTF-8"?><policy xmlns:ps="http://www.novell.com/nxsl/java/com.netiq.resources.ProvisioningScheduler">
	<rule>
		<description>Remove Group Membership changes if using Group Entitlement</description>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.entitlement.Group" op="equal">true</if-global-variable>
				<if-operation mode="regex" op="equal">add|modify</if-operation>
				<if-op-attr name="Member" op="available"/>
			</and>
		</conditions>
		<actions>
			<do-strip-op-attr name="Member"/>
		</actions>
	</rule>
	<rule>
		<description>Login Disabled attribute change in IDVault</description>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="equal">true</if-global-variable>
				<if-global-variable mode="nocase" name="drv.sync.disabled" op="equal">false</if-global-variable>
				<if-operation mode="case" op="equal">modify</if-operation>
				<if-op-attr name="Login Disabled" op="available"/>
			</and>
		</conditions>
		<actions>
			<do-strip-op-attr name="Login Disabled"/>
		</actions>
	</rule>
	<rule>
		<description>Disable account for delete operation when using account entitlement</description>
		<conditions>
			<and>
				<if-operation mode="case" op="equal">delete</if-operation>
				<if-class-name mode="nocase" op="equal">User</if-class-name>
				<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="equal">true</if-global-variable>
			</and>
		</conditions>
		<actions>
			<do-set-dest-attr-value class-name="User" name="Login Disabled" when="before">
				<arg-association>
					<token-association/>
				</arg-association>
				<arg-value type="string">
					<token-text xml:space="preserve">true</token-text>
				</arg-value>
			</do-set-dest-attr-value>
			<do-veto/>
		</actions>
	</rule>
	<rule>
		<description>User Account Entitlement change (Delete Option)</description>
		<comment xml:space="preserve">The User Account Entitlement grants the user an enabled account in Active Directory. Revoking the entitlement will disable or delete the Active Directory account depending on the value you select for the 'When account entitlement revoked' global variable. This rule executes when the entitlement is changing and you have selected the delete option.</comment>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="equal">true</if-global-variable>
				<if-global-variable name="drv.entitlement.remove" op="equal">delete</if-global-variable>
				<if-class-name op="equal">User</if-class-name>
				<if-operation op="equal">modify</if-operation>
				<if-entitlement name="UserAccount" op="changing"/>
			</and>
		</conditions>
		<actions>
			<do-set-local-variable name="nrfhistoryCheck" scope="policy">
				<arg-string>
					<token-text xml:space="preserve"/>
				</arg-string>
			</do-set-local-variable>
			<do-if>
				<arg-conditions>
					<and>
						<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.UserAccount.onboard" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.onboard.loopback" op="equal">true</if-global-variable>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryValue" scope="policy">
						<arg-node-set>
							<token-query class-name="User" datastore="src" scope="entry">
								<arg-dn>
									<token-src-dn/>
								</arg-dn>
								<arg-string>
									<token-text xml:space="preserve">nrfResourceHistory</token-text>
								</arg-string>
							</token-query>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="nrfhistoryCheck" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="entitlementDN" scope="policy">
						<arg-string>
							<token-map dest="entitlementDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">UserAccount</token-text>
							</token-map>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">UserAccount</token-text>
							</token-map>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
							<token-xpath expression='$static-map-xml/mapping-table/row[col/text()="UserAccount"]/col[3]/text()'/>
						</arg-node-set>
					</do-set-local-variable>
					<do-for-each>
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="resourceDN" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">\</token-text>
									<token-global-variable name="dirxml.auto.treename"/>
									<token-text xml:space="preserve">\</token-text>
									<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
										<token-local-variable name="current-node"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="nrfhistoryCheck" scope="policy">
								<arg-node-set>
									<token-local-variable name="nrfhistoryCheck"/>
									<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
					</do-for-each>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-for-each>
				<arg-node-set>
					<token-removed-entitlement name="UserAccount"/>
				</arg-node-set>
				<arg-actions>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="0"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change.</token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-delete-dest-object/>
							<do-clear-src-attr-value name="DirXML-ADAliasName"/>
							<do-clear-src-attr-value name="DirXML-ADContext"/>
							<do-remove-association when="after">
								<arg-association>
									<token-association/>
								</arg-association>
							</do-remove-association>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
			<do-for-each>
				<arg-node-set>
					<token-added-entitlement name="UserAccount"/>
				</arg-node-set>
				<arg-actions>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="1"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change.</token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-dest-attr-value name="Login Disabled">
								<arg-value type="state">
									<token-text>false</token-text>
								</arg-value>
							</do-set-dest-attr-value>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
	<rule>
		<description>User Account Entitlement change (Disable Option)</description>
		<comment>The User Account Entitlement grants the user an enabled account in Active Directory. Revoking the entitlement will disable or delete the Active Directory account depending on the value you select for the 'When account entitlement revoked' global variable. This rule executes when the entitlement is changing and you have selected the disable option.</comment>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="equal">true</if-global-variable>
				<if-global-variable name="drv.entitlement.remove" op="equal">disable</if-global-variable>
				<if-class-name op="equal">User</if-class-name>
				<if-operation mode="regex" op="equal">add|modify</if-operation>
				<if-entitlement name="UserAccount" op="changing"/>
			</and>
		</conditions>
		<actions>
			<do-set-local-variable name="nrfhistoryCheck" scope="policy">
				<arg-string>
					<token-text xml:space="preserve"/>
				</arg-string>
			</do-set-local-variable>
			<do-if>
				<arg-conditions>
					<and>
						<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.UserAccount.onboard" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.onboard.loopback" op="equal">true</if-global-variable>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryValue" scope="policy">
						<arg-node-set>
							<token-query class-name="User" datastore="src" scope="entry">
								<arg-dn>
									<token-src-dn/>
								</arg-dn>
								<arg-string>
									<token-text xml:space="preserve">nrfResourceHistory</token-text>
								</arg-string>
							</token-query>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="nrfhistoryCheck" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="entitlementDN" scope="policy">
						<arg-string>
							<token-map dest="entitlementDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">UserAccount</token-text>
							</token-map>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">UserAccount</token-text>
							</token-map>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
							<token-xpath expression='$static-map-xml/mapping-table/row[col/text()="UserAccount"]/col[3]/text()'/>
						</arg-node-set>
					</do-set-local-variable>
					<do-for-each>
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="resourceDN" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">\</token-text>
									<token-global-variable name="dirxml.auto.treename"/>
									<token-text xml:space="preserve">\</token-text>
									<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
										<token-local-variable name="current-node"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="nrfhistoryCheck" scope="policy">
								<arg-node-set>
									<token-local-variable name="nrfhistoryCheck"/>
									<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
					</do-for-each>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-for-each>
				<arg-node-set>
					<token-removed-entitlement name="UserAccount"/>
				</arg-node-set>
				<arg-actions>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="0"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change.</token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-dest-attr-value name="Login Disabled">
								<arg-value type="state">
									<token-text>true</token-text>
								</arg-value>
							</do-set-dest-attr-value>
							<do-clear-src-attr-value name="DirXML-ADAliasName"/>
							<do-clear-src-attr-value name="DirXML-ADContext"/>
							<do-remove-association when="after">
								<arg-association>
									<token-association/>
								</arg-association>
							</do-remove-association>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
			<do-for-each>
				<arg-node-set>
					<token-added-entitlement name="UserAccount"/>
				</arg-node-set>
				<arg-actions>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="1"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change.</token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-dest-attr-value name="Login Disabled">
								<arg-value type="state">
									<token-text>false</token-text>
								</arg-value>
							</do-set-dest-attr-value>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
	<rule>
		<description>Check User modify for group membership being granted or revoked</description>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.entitlement.Group" op="equal">true</if-global-variable>
				<if-class-name op="equal">User</if-class-name>
				<if-operation op="equal">modify</if-operation>
				<if-entitlement name="Group" op="changing"/>
			</and>
		</conditions>
		<actions>
			<do-set-local-variable name="nrfhistoryCheck" scope="policy">
				<arg-string>
					<token-text xml:space="preserve"/>
				</arg-string>
			</do-set-local-variable>
			<do-if>
				<arg-conditions>
					<and>
						<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.Group.onboard" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.onboard.loopback" op="equal">true</if-global-variable>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryValue" scope="policy">
						<arg-node-set>
							<token-query class-name="User" datastore="src" scope="entry">
								<arg-dn>
									<token-src-dn/>
								</arg-dn>
								<arg-string>
									<token-text xml:space="preserve">nrfResourceHistory</token-text>
								</arg-string>
							</token-query>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="entitlementDN" scope="policy">
						<arg-string>
							<token-map dest="entitlementDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">Group</token-text>
							</token-map>
						</arg-string>
					</do-set-local-variable>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-for-each>
				<arg-node-set>
					<token-removed-entitlement name="Group"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryCheck" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="assoc" scope="policy">
						<arg-string>
							<token-xpath expression="es:getEntParamField($current-node,&apos;ID&apos;)&#xa;"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="groupName" scope="policy">
						<arg-string>
							<token-xpath expression="es:getEntParamField($current-node,&apos;ID2&apos;)&#xd;&#xa;"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
							<token-xpath expression="$static-map-xml/mapping-table/row[translate(col[2]/text(),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')=translate($groupName,'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')]/col[3]/text()"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="resourceDNs" op="equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="resourceDNs" scope="policy">
								<arg-node-set>
									<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
										<token-text xml:space="preserve">Group</token-text>
									</token-map>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-for-each>
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="resourceDN" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">\</token-text>
									<token-global-variable name="dirxml.auto.treename"/>
									<token-text xml:space="preserve">\</token-text>
									<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
										<token-local-variable name="current-node"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="nrfhistoryCheck" scope="policy">
								<arg-node-set>
									<token-local-variable name="nrfhistoryCheck"/>
									<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
					</do-for-each>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="paramValue" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">{"ID":"</token-text>
									<token-text xml:space="preserve"/>
									<token-local-variable name="assoc"/>
									<token-text xml:space="preserve">","ID2":"</token-text>
									<token-local-variable name="groupName"/>
									<token-text xml:space="preserve">"}</token-text>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="0"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN and component/ref/param/text()=$paramValue ]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change. </token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-remove-dest-attr-value class-name="Group" name="Member">
								<arg-association>
									<token-local-variable name="assoc"/>
								</arg-association>
								<arg-value type="dn">
									<token-src-dn/>
								</arg-value>
							</do-remove-dest-attr-value>
							<do-set-xml-attr expression="../modify[last()]/modify-attr[last()]/remove-value[last()]/value[last()]" name="association-ref">
								<arg-string>
									<token-association/>
								</arg-string>
							</do-set-xml-attr>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
			<do-for-each>
				<arg-node-set>
					<token-added-entitlement name="Group"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryCheck" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="assoc" scope="policy">
						<arg-string>
							<token-xpath expression="es:getEntParamField($current-node,'ID')"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="groupName" scope="policy">
						<arg-string>
							<token-xpath expression="es:getEntParamField($current-node,&apos;ID2&apos;)&#xd;&#xa;"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
							<token-xpath expression="$static-map-xml/mapping-table/row[translate(col[2]/text(),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')=translate($groupName,'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')]/col[3]/text()"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="resourceDNs" op="equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="resourceDNs" scope="policy">
								<arg-node-set>
									<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
										<token-text xml:space="preserve">Group</token-text>
									</token-map>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-for-each>
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="resourceDN" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">\</token-text>
									<token-global-variable name="dirxml.auto.treename"/>
									<token-text xml:space="preserve">\</token-text>
									<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
										<token-local-variable name="current-node"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="nrfhistoryCheck" scope="policy">
								<arg-node-set>
									<token-local-variable name="nrfhistoryCheck"/>
									<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
					</do-for-each>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="paramValue" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">{"ID":"</token-text>
									<token-text xml:space="preserve"/>
									<token-local-variable name="assoc"/>
									<token-text xml:space="preserve">","ID2":"</token-text>
									<token-local-variable name="groupName"/>
									<token-text xml:space="preserve">"}</token-text>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="1"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN and component/ref/param/text()=$paramValue]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change. </token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="groupName" scope="policy">
								<arg-string>
									<token-xpath expression="es:getEntParamField($current-node, 'ID2')"/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="groupReply" scope="policy">
								<arg-node-set>
									<token-query class-name="User" scope="entry">
										<arg-association>
											<token-association/>
										</arg-association>
										<arg-match-attr name="Group Membership">
											<arg-value type="string">
												<token-local-variable name="groupName"/>
											</arg-value>
										</arg-match-attr>
									</token-query>
								</arg-node-set>
							</do-set-local-variable>
							<do-set-local-variable name="performEntitlementAdd" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
							<do-for-each>
								<arg-node-set>
									<token-local-variable name="groupReply"/>
								</arg-node-set>
								<arg-actions>
									<do-set-local-variable name="performEntitlementAdd" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
							</do-for-each>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="performEntitlementAdd" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-add-dest-attr-value class-name="Group" name="Member">
										<arg-association>
											<token-local-variable name="assoc"/>
										</arg-association>
										<arg-value type="dn">
											<token-src-dn/>
										</arg-value>
									</do-add-dest-attr-value>
									<do-set-xml-attr expression="../modify[last()]/modify-attr[last()]/add-value[last()]/value[last()]" name="association-ref">
										<arg-string>
											<token-association/>
										</arg-string>
									</do-set-xml-attr>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
	<rule>
		<description>Check User modify for Exchange mailbox being granted or revoked</description>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.exchMailboxMethod" op="equal">entitlement</if-global-variable>
				<if-class-name op="equal">User</if-class-name>
				<if-operation op="equal">modify</if-operation>
				<if-entitlement name="ExchangeMailbox" op="changing"/>
			</and>
		</conditions>
		<actions>
			<do-set-local-variable name="nrfhistoryCheck" scope="policy">
				<arg-string>
					<token-text xml:space="preserve"/>
				</arg-string>
			</do-set-local-variable>
			<do-if>
				<arg-conditions>
					<and>
						<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.Exchange.onboard" op="equal">true</if-global-variable>
						<if-global-variable mode="nocase" name="drv.entitlement.onboard.loopback" op="equal">true</if-global-variable>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryValue" scope="policy">
						<arg-node-set>
							<token-query class-name="User" datastore="src" scope="entry">
								<arg-dn>
									<token-src-dn/>
								</arg-dn>
								<arg-string>
									<token-text xml:space="preserve">nrfResourceHistory</token-text>
								</arg-string>
							</token-query>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="entitlementDN" scope="policy">
						<arg-string>
							<token-map dest="entitlementDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">ExchangeMailbox</token-text>
							</token-map>
						</arg-string>
					</do-set-local-variable>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-for-each>
				<arg-node-set>
					<token-removed-entitlement name="ExchangeMailbox"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryCheck" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="homeMDB" scope="policy">
						<arg-string>
							<token-xpath expression="es:getEntParamField($current-node,'ID')"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
							<token-xpath expression="$static-map-xml/mapping-table/row[col[1]/text()=&quot;ExchangeMailbox&quot; and translate(col[2]/text(),&apos;ABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;,&apos;abcdefghijklmnopqrstuvwxyz&apos;)=translate($homeMDB,&apos;ABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;,&apos;abcdefghijklmnopqrstuvwxyz&apos;)]/col[3]/text()"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="resourceDNs" op="equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="resourceDNs" scope="policy">
								<arg-node-set>
									<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
										<token-text xml:space="preserve">ExchangeMailbox</token-text>
									</token-map>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-for-each>
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="resourceDN" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">\</token-text>
									<token-global-variable name="dirxml.auto.treename"/>
									<token-text xml:space="preserve">\</token-text>
									<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
										<token-local-variable name="current-node"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="nrfhistoryCheck" scope="policy">
								<arg-node-set>
									<token-local-variable name="nrfhistoryCheck"/>
									<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
					</do-for-each>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="0"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change. </token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-remove-dest-attr-value name="homeMDB">
								<arg-value type="string">
									<token-local-variable name="homeMDB"/>
								</arg-value>
							</do-remove-dest-attr-value>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
			<do-for-each>
				<arg-node-set>
					<token-added-entitlement name="ExchangeMailbox"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="nrfhistoryCheck" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-xpath expression="empty"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="homeMDB" scope="policy">
						<arg-string>
							<token-xpath expression="es:getEntParamField($current-node,'ID')"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="resourceDNs" scope="policy">
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
							<token-xpath expression="$static-map-xml/mapping-table/row[col[1]/text()=&quot;ExchangeMailbox&quot; and translate(col[2]/text(),&apos;ABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;,&apos;abcdefghijklmnopqrstuvwxyz&apos;)=translate($homeMDB,&apos;ABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;,&apos;abcdefghijklmnopqrstuvwxyz&apos;)]/col[3]/text()"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="resourceDNs" op="equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="resourceDNs" scope="policy">
								<arg-node-set>
									<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
										<token-text xml:space="preserve">ExchangeMailbox</token-text>
									</token-map>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-for-each>
						<arg-node-set>
							<token-local-variable name="resourceDNs"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="resourceDN" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">\</token-text>
									<token-global-variable name="dirxml.auto.treename"/>
									<token-text xml:space="preserve">\</token-text>
									<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
										<token-local-variable name="current-node"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="nrfhistoryCheck" scope="policy">
								<arg-node-set>
									<token-local-variable name="nrfhistoryCheck"/>
									<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
					</do-for-each>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="checkOperation" scope="policy">
								<arg-node-set>
									<token-xml-parse>
										<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
									</token-xml-parse>
								</arg-node-set>
							</do-set-local-variable>
							<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="1"]/component[@name="path"]/text()'/>
							<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-xml-serialize>
											<token-local-variable name="checkOperation"/>
										</token-xml-serialize>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="payload" notrace="true" scope="policy">
								<arg-string>
									<token-replace-all regex="&amp;lt;" replace-with="&lt;">
										<token-base64-decode charset="UTF-8">
											<token-local-variable name="checkPayLoad"/>
										</token-base64-decode>
									</token-replace-all>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="checkPayLoad" scope="policy">
								<arg-string>
									<token-base64-encode charset="UTF-8">
										<token-local-variable name="payload"/>
									</token-base64-encode>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
										<token-global-variable name="UAProvAdmin"/>
									</token-parse-dn>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="timeStamp" scope="policy">
								<arg-string>
									<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN]/@timestamp'/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="rpStatus" scope="policy">
								<arg-string>
									<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-set-local-variable name="entStatus" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">false</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Ignoring entitlement change. </token-text>
										</arg-string>
									</do-trace-message>
								</arg-actions>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="entStatus" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="homeMDB" scope="policy">
								<arg-string>
									<token-xpath expression="es:getEntParamField($current-node,'ID')"/>
								</arg-string>
							</do-set-local-variable>
							<do-add-dest-attr-value name="homeMDB">
								<arg-value type="string">
									<token-local-variable name="homeMDB"/>
								</arg-value>
							</do-add-dest-attr-value>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
	<rule>
		<description>Extended entitlement change</description>
		<comment xml:space="preserve">A Entitlement Action Tag will be set in operation property for each added entitlement value</comment>
		<conditions>
			<or>
				<if-class-name op="equal">User</if-class-name>
			</or>
			<or>
				<if-operation mode="case" op="equal">add</if-operation>
				<if-operation mode="case" op="equal">modify</if-operation>
			</or>
			<or>
				<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
			</or>
		</conditions>
		<actions>
			<do-set-local-variable name="nrfhistoryCheck" scope="policy">
				<arg-string>
					<token-text xml:space="preserve"/>
				</arg-string>
			</do-set-local-variable>
			<do-set-local-variable name="ent-names" scope="policy">
				<arg-node-set>
					<token-xpath expression="$perm-map-xml/mapping-table/row/col[1]/text()"/>
				</arg-node-set>
			</do-set-local-variable>
			<do-for-each>
				<arg-node-set>
					<token-local-variable name="ent-names"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="entName" scope="policy">
						<arg-string>
							<token-local-variable name="current-node"/>
						</arg-string>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="entName" op="not-equal">Group</if-local-variable>
								<if-local-variable mode="nocase" name="entName" op="not-equal">UserAccount</if-local-variable>
								<if-local-variable mode="nocase" name="entName" op="not-equal">ExchangeMailbox</if-local-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.onboard.loopback" op="equal">true</if-global-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="nrfhistoryValue" scope="policy">
								<arg-node-set>
									<token-query class-name="User" datastore="src" scope="entry">
										<arg-dn>
											<token-src-dn/>
										</arg-dn>
										<arg-string>
											<token-text xml:space="preserve">nrfResourceHistory</token-text>
										</arg-string>
									</token-query>
								</arg-node-set>
							</do-set-local-variable>
							<do-set-local-variable name="entitlementDN" scope="policy">
								<arg-string>
									<token-map dest="entitlementDN" src="entitlementName" table="..\PermissionEntMapping">
										<token-local-variable name="entName"/>
									</token-map>
								</arg-string>
							</do-set-local-variable>
							<do-for-each>
								<arg-node-set>
									<token-removed-entitlement name="$entName$"/>
								</arg-node-set>
								<arg-actions>
									<do-set-local-variable name="nrfhistoryCheck" scope="policy">
										<arg-node-set>
											<token-xpath expression="empty"/>
										</arg-node-set>
									</do-set-local-variable>
									<do-set-local-variable name="resourceDNs" scope="policy">
										<arg-node-set>
											<token-xpath expression="empty"/>
										</arg-node-set>
									</do-set-local-variable>
									<do-set-local-variable name="entValue" scope="policy">
										<arg-string>
											<token-xpath expression="es:getEntParamField($current-node,&apos;ID&apos;)&#xa;"/>
										</arg-string>
									</do-set-local-variable>
									<do-set-local-variable name="resourceDNs" scope="policy">
										<arg-node-set>
											<token-local-variable name="resourceDNs"/>
											<token-xpath expression="$static-map-xml/mapping-table/row[col[1]/text()=$entName and translate(col[2]/text(),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')=translate($entValue,'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')]/col[3]/text()"/>
										</arg-node-set>
									</do-set-local-variable>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="resourceDNs" op="equal"/>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="resourceDNs" scope="policy">
												<arg-node-set>
													<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
														<token-local-variable name="entName"/>
													</token-map>
												</arg-node-set>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions/>
									</do-if>
									<do-for-each>
										<arg-node-set>
											<token-local-variable name="resourceDNs"/>
										</arg-node-set>
										<arg-actions>
											<do-set-local-variable name="resourceDN" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">\</token-text>
													<token-global-variable name="dirxml.auto.treename"/>
													<token-text xml:space="preserve">\</token-text>
													<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
														<token-local-variable name="current-node"/>
													</token-parse-dn>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="nrfhistoryCheck" scope="policy">
												<arg-node-set>
													<token-local-variable name="nrfhistoryCheck"/>
													<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
												</arg-node-set>
											</do-set-local-variable>
										</arg-actions>
									</do-for-each>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="paramValue" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">{"ID":"</token-text>
													<token-local-variable name="entValue"/>
													<token-text xml:space="preserve">"}</token-text>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="checkOperation" scope="policy">
												<arg-node-set>
													<token-xml-parse>
														<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
													</token-xml-parse>
												</arg-node-set>
											</do-set-local-variable>
											<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="0"]/component[@name="path"]/text()'/>
											<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
												<arg-string>
													<token-base64-encode charset="UTF-8">
														<token-xml-serialize>
															<token-local-variable name="checkOperation"/>
														</token-xml-serialize>
													</token-base64-encode>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="payload" notrace="true" scope="policy">
												<arg-string>
													<token-replace-all regex="&amp;lt;" replace-with="&lt;">
														<token-base64-decode charset="UTF-8">
															<token-local-variable name="checkPayLoad"/>
														</token-base64-decode>
													</token-replace-all>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="checkPayLoad" scope="policy">
												<arg-string>
													<token-base64-encode charset="UTF-8">
														<token-local-variable name="payload"/>
													</token-base64-encode>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
												<arg-string>
													<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
														<token-global-variable name="UAProvAdmin"/>
													</token-parse-dn>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="timeStamp" scope="policy">
												<arg-string>
													<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN and component/ref/param/text()=$paramValue]/@timestamp'/>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="rpStatus" scope="policy">
												<arg-string>
													<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
												</arg-string>
											</do-set-local-variable>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="entStatus" scope="policy">
														<arg-string>
															<token-text xml:space="preserve">true</token-text>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
												<arg-actions>
													<do-set-local-variable name="entStatus" scope="policy">
														<arg-string>
															<token-text xml:space="preserve">false</token-text>
														</arg-string>
													</do-set-local-variable>
													<do-trace-message>
														<arg-string>
															<token-text xml:space="preserve">Ignoring entitlement change. </token-text>
														</arg-string>
													</do-trace-message>
												</arg-actions>
											</do-if>
										</arg-actions>
										<arg-actions>
											<do-set-local-variable name="entStatus" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">true</token-text>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
									</do-if>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="assignAttr" scope="policy">
												<arg-string>
													<token-map dest="assignmentAttribute" src="entitlementName" table="..\PermissionEntMapping">
														<token-local-variable name="entName"/>
													</token-map>
												</arg-string>
											</do-set-local-variable>
											<do-remove-dest-attr-value name="$assignAttr$">
												<arg-value type="string">
													<token-local-variable name="entValue"/>
												</arg-value>
											</do-remove-dest-attr-value>
										</arg-actions>
										<arg-actions/>
									</do-if>
								</arg-actions>
							</do-for-each>
							<do-for-each>
								<arg-node-set>
									<token-added-entitlement name="$entName$"/>
								</arg-node-set>
								<arg-actions>
									<do-set-local-variable name="nrfhistoryCheck" scope="policy">
										<arg-node-set>
											<token-xpath expression="empty"/>
										</arg-node-set>
									</do-set-local-variable>
									<do-set-local-variable name="resourceDNs" scope="policy">
										<arg-node-set>
											<token-xpath expression="empty"/>
										</arg-node-set>
									</do-set-local-variable>
									<do-set-local-variable name="entValue" scope="policy">
										<arg-string>
											<token-xpath expression="es:getEntParamField($current-node,&apos;ID&apos;)&#xa;"/>
										</arg-string>
									</do-set-local-variable>
									<do-set-local-variable name="resourceDNs" scope="policy">
										<arg-node-set>
											<token-local-variable name="resourceDNs"/>
											<token-xpath expression="$static-map-xml/mapping-table/row[col[1]/text()=$entName and translate(col[2]/text(),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')=translate($entValue,'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz')]/col[3]/text()"/>
										</arg-node-set>
									</do-set-local-variable>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="resourceDNs" op="equal"/>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="resourceDNs" scope="policy">
												<arg-node-set>
													<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
														<token-local-variable name="entName"/>
													</token-map>
												</arg-node-set>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions/>
									</do-if>
									<do-for-each>
										<arg-node-set>
											<token-local-variable name="resourceDNs"/>
										</arg-node-set>
										<arg-actions>
											<do-set-local-variable name="resourceDN" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">\</token-text>
													<token-global-variable name="dirxml.auto.treename"/>
													<token-text xml:space="preserve">\</token-text>
													<token-parse-dn dest-dn-format="slash" src-dn-format="ldap">
														<token-local-variable name="current-node"/>
													</token-parse-dn>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="nrfhistoryCheck" scope="policy">
												<arg-node-set>
													<token-local-variable name="nrfhistoryCheck"/>
													<token-xpath expression='$nrfhistoryValue/attr/value[component[@name="volume"]/text()=$resourceDN]'/>
												</arg-node-set>
											</do-set-local-variable>
										</arg-actions>
									</do-for-each>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="nrfhistoryCheck" op="not-equal"/>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="paramValue" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">{"ID":"</token-text>
													<token-local-variable name="entValue"/>
													<token-text xml:space="preserve">"}</token-text>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="checkOperation" scope="policy">
												<arg-node-set>
													<token-xml-parse>
														<token-text xml:space="preserve">&lt;status>&lt;/status></token-text>
													</token-xml-parse>
												</arg-node-set>
											</do-set-local-variable>
											<do-clone-xpath dest-expression="$checkOperation/status" src-expression='$nrfhistoryCheck[component[@name="nameSpace"]/text()="1"]/component[@name="path"]/text()'/>
											<do-set-local-variable name="checkPayLoad" notrace="true" scope="policy">
												<arg-string>
													<token-base64-encode charset="UTF-8">
														<token-xml-serialize>
															<token-local-variable name="checkOperation"/>
														</token-xml-serialize>
													</token-base64-encode>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="payload" notrace="true" scope="policy">
												<arg-string>
													<token-replace-all regex="&amp;lt;" replace-with="&lt;">
														<token-base64-decode charset="UTF-8">
															<token-local-variable name="checkPayLoad"/>
														</token-base64-decode>
													</token-replace-all>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="checkPayLoad" scope="policy">
												<arg-string>
													<token-base64-encode charset="UTF-8">
														<token-local-variable name="payload"/>
													</token-base64-encode>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="adminQualifiedLDAPDn" scope="policy">
												<arg-string>
													<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-dot">
														<token-global-variable name="UAProvAdmin"/>
													</token-parse-dn>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="timeStamp" scope="policy">
												<arg-string>
													<token-xpath expression='./modify-attr[@attr-name="DirXML-EntitlementRef"]/add-value/value[component[@name="volume"]/text()=$entitlementDN and component/ref/param/text()=$paramValue]/@timestamp '/>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="rpStatus" scope="policy">
												<arg-string>
													<token-xpath expression="ps:AllowEntitlementGrantOrRevoke($adminQualifiedLDAPDn,$timeStamp,$checkPayLoad,true)"/>
												</arg-string>
											</do-set-local-variable>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="rpStatus" op="equal">true</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="entStatus" scope="policy">
														<arg-string>
															<token-text xml:space="preserve">true</token-text>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
												<arg-actions>
													<do-set-local-variable name="entStatus" scope="policy">
														<arg-string>
															<token-text xml:space="preserve">false</token-text>
														</arg-string>
													</do-set-local-variable>
													<do-trace-message>
														<arg-string>
															<token-text xml:space="preserve">Ignoring entitlement change. </token-text>
														</arg-string>
													</do-trace-message>
												</arg-actions>
											</do-if>
										</arg-actions>
										<arg-actions>
											<do-set-local-variable name="entStatus" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">true</token-text>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
									</do-if>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="entStatus" op="equal">true</if-local-variable>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="performEntitlementAdd" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">true</token-text>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="assignAttr" scope="policy">
												<arg-string>
													<token-map dest="assignmentAttribute" src="entitlementName" table="..\PermissionEntMapping">
														<token-local-variable name="entName"/>
													</token-map>
												</arg-string>
											</do-set-local-variable>
											<do-if>
												<arg-conditions>
													<and>
														<if-operation mode="nocase" op="equal">modify</if-operation>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="queryReply" scope="policy">
														<arg-node-set>
															<token-query class-name="User" scope="entry">
																<arg-association>
																	<token-association/>
																</arg-association>
																<arg-match-attr name="$assignAttr$">
																	<arg-value type="string">
																		<token-local-variable name="entValue"/>
																	</arg-value>
																</arg-match-attr>
															</token-query>
														</arg-node-set>
													</do-set-local-variable>
													<do-for-each>
														<arg-node-set>
															<token-local-variable name="queryReply"/>
														</arg-node-set>
														<arg-actions>
															<do-set-local-variable name="performEntitlementAdd" scope="policy">
																<arg-string>
																	<token-text xml:space="preserve">false</token-text>
																</arg-string>
															</do-set-local-variable>
														</arg-actions>
													</do-for-each>
												</arg-actions>
												<arg-actions/>
											</do-if>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="performEntitlementAdd" op="equal">true</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-add-dest-attr-value name="$assignAttr$">
														<arg-value type="string">
															<token-local-variable name="entValue"/>
														</arg-value>
													</do-add-dest-attr-value>
												</arg-actions>
												<arg-actions/>
											</do-if>
										</arg-actions>
										<arg-actions/>
									</do-if>
								</arg-actions>
							</do-for-each>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
</policy>