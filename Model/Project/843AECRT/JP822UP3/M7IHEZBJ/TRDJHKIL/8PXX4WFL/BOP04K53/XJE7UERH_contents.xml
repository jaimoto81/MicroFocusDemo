<?xml version="1.0" encoding="UTF-8"?><policy xmlns:es="http://www.novell.com/nxsl/ecmascript">
	<rule>
		<description>Add User Multi-value Permission values to Operation Data</description>
		<conditions>
			<or>
				<if-class-name mode="nocase" op="equal">User</if-class-name>
			</or>
			<or>
				<if-operation mode="nocase" op="equal">add</if-operation>
				<if-operation op="equal">modify</if-operation>
			</or>
			<or>
				<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
			</or>
		</conditions>
		<actions>
			<do-if>
				<arg-conditions>
					<and>
						<if-xpath op="not-true">operation-data</if-xpath>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-append-xml-element expression="." name="operation-data"/>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-set-local-variable name="perm-attrs" scope="policy">
				<arg-node-set>
					<token-xpath expression="$perm-map-xml/mapping-table/row/col[last()]/text()"/>
				</arg-node-set>
			</do-set-local-variable>
			<do-for-each>
				<arg-node-set>
					<token-local-variable name="perm-attrs"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="assignAttr" scope="policy">
						<arg-string>
							<token-local-variable name="current-node"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="reconcileAttrFlg" scope="policy">
						<arg-string>
							<token-text xml:space="preserve">false</token-text>
						</arg-string>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="current-node" op="equal">Group Membership</if-local-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.Group" op="equal">false</if-global-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.Group.onboard" op="equal">true</if-global-variable>
								<if-op-attr name="$current-node$" op="changing"/>
							</and>
							<and>
								<if-local-variable mode="nocase" name="current-node" op="equal">Login Disabled</if-local-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="equal">false</if-global-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.UserAccount.onboard" op="equal">true</if-global-variable>
								<if-op-attr name="$current-node$" op="changing"/>
							</and>
							<and>
								<if-local-variable mode="nocase" name="current-node" op="equal">Login Disabled</if-local-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="equal">true</if-global-variable>
								<if-global-variable mode="nocase" name="drv.sync.disabled" op="equal">true</if-global-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.UserAccount.onboard" op="equal">true</if-global-variable>
								<if-op-attr name="$current-node$" op="changing"/>
							</and>
							<and>
								<if-local-variable mode="nocase" name="current-node" op="equal">Mailbox ID</if-local-variable>
								<if-global-variable mode="nocase" name="drv.exchMailboxMethod" op="equal">disabled</if-global-variable>
								<if-global-variable mode="nocase" name="drv.entitlement.Exchange.onboard" op="equal">true</if-global-variable>
								<if-op-attr name="$current-node$" op="changing"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-trace-message>
								<arg-string>
									<token-text xml:space="preserve">Reconciling permission for attribute: </token-text>
									<token-local-variable name="current-node"/>
								</arg-string>
							</do-trace-message>
							<do-set-local-variable name="reconcileAttrFlg" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="current-node" op="not-equal">Group Membership</if-local-variable>
										<if-local-variable mode="nocase" name="current-node" op="not-equal">Login Disabled</if-local-variable>
										<if-local-variable mode="nocase" name="current-node" op="not-equal">Mailbox ID</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-if>
										<arg-conditions>
											<and>
												<if-global-variable mode="nocase" name="drv.entitlement.onboarding.all" op="equal">true</if-global-variable>
												<if-op-attr name="$assignAttr$" op="changing"/>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-trace-message>
												<arg-string>
													<token-text xml:space="preserve">Reconciling permission for attribute: </token-text>
													<token-local-variable name="assignAttr"/>
												</arg-string>
											</do-trace-message>
											<do-set-local-variable name="reconcileAttrFlg" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">true</token-text>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions>
											<do-for-each>
												<arg-node-set>
													<token-global-variable name="drv.entitlement.onboardEnt"/>
												</arg-node-set>
												<arg-actions>
													<do-set-local-variable name="givenAttr" scope="policy">
														<arg-string>
															<token-xpath expression='$current-node/definition[@name="drv.entitlement.entName"]/value/text()'/>
														</arg-string>
													</do-set-local-variable>
													<do-if>
														<arg-conditions>
															<and>
																<if-local-variable mode="nocase" name="assignAttr" op="equal">$givenAttr$</if-local-variable>
																<if-op-attr name="$givenAttr$" op="changing"/>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-trace-message>
																<arg-string>
																	<token-text xml:space="preserve">Reconciling permission for attribute: </token-text>
																	<token-local-variable name="givenAttr"/>
																</arg-string>
															</do-trace-message>
															<do-set-local-variable name="reconcileAttrFlg" scope="policy">
																<arg-string>
																	<token-text xml:space="preserve">true</token-text>
																</arg-string>
															</do-set-local-variable>
														</arg-actions>
														<arg-actions/>
													</do-if>
												</arg-actions>
											</do-for-each>
										</arg-actions>
									</do-if>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="nocase" name="reconcileAttrFlg" op="equal">true</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="permission-values" scope="policy">
								<arg-node-set>
									<token-attr name="$current-node$"/>
								</arg-node-set>
							</do-set-local-variable>
							<do-append-xml-element expression="operation-data" name="permission"/>
							<do-set-xml-attr expression="operation-data/permission[last()]" name="name">
								<arg-string>
									<token-local-variable name="assignAttr"/>
								</arg-string>
							</do-set-xml-attr>
							<do-set-local-variable name="entitlementDN" scope="policy">
								<arg-string>
									<token-map dest="entitlementDN" src="assignmentAttribute" table="..\PermissionEntMapping">
										<token-local-variable name="assignAttr"/>
									</token-map>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="entitlementObj" scope="policy">
								<arg-node-set>
									<token-query class-name="DirXML-Entitlement" datastore="src" scope="entry">
										<arg-dn>
											<token-local-variable name="entitlementDN"/>
										</arg-dn>
									</token-query>
								</arg-node-set>
							</do-set-local-variable>
							<do-set-local-variable name="entitlementQualifiedDn" scope="policy">
								<arg-string>
									<token-xpath expression="$entitlementObj/@qualified-src-dn"/>
								</arg-string>
							</do-set-local-variable>
							<do-set-xml-attr expression="operation-data/permission[last()]" name="entitlement">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
										<token-local-variable name="entitlementQualifiedDn"/>
									</token-parse-dn>
								</arg-string>
							</do-set-xml-attr>
							<do-set-xml-attr expression="operation-data/permission[last()]" name="dynamic">
								<arg-string>
									<token-text xml:space="preserve">true</token-text>
								</arg-string>
							</do-set-xml-attr>
							<do-set-xml-attr expression="operation-data/permission[last()]" name="resource">
								<arg-string>
									<token-map dest="resourceDN" src="assignmentAttribute" table="..\PermissionEntMapping">
										<token-local-variable name="assignAttr"/>
									</token-map>
								</arg-string>
							</do-set-xml-attr>
							<do-for-each>
								<arg-node-set>
									<token-local-variable name="permission-values"/>
								</arg-node-set>
								<arg-actions>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="assignAttr" op="equal">Group Membership</if-local-variable>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="groupName" scope="policy">
												<arg-string>
													<token-parse-dn dest-dn-format="ldap" length="-1" src-dn-format="slash" start="-1">
														<token-local-variable name="current-node"/>
													</token-parse-dn>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="groupFQDN" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">CN=</token-text>
													<token-local-variable name="groupName"/>
													<token-text xml:space="preserve">,</token-text>
													<token-xpath expression="es:convertLDAPtoUpper($drv.user.container)"/>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="staticMappedGroupResource" scope="policy">
												<arg-string>
													<token-map dest="staticResource" src="entitlementValue" table="..\StaticValueEntitlementMap">
														<token-local-variable name="groupFQDN"/>
													</token-map>
												</arg-string>
											</do-set-local-variable>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="staticMappedGroupResource" op="equal"/>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-append-xml-element expression="operation-data/permission[@dynamic='true'][last()]" name="pvalue"/>
													<do-set-local-variable name="permValue" scope="policy">
														<arg-string>
															<token-map dest="entValue" src="nativeName" table="..\Group_Values">
																<token-local-variable name="groupFQDN"/>
															</token-map>
														</arg-string>
													</do-set-local-variable>
													<do-append-xml-text expression="operation-data/permission[@dynamic='true'][last()]/pvalue[last()]">
														<arg-string>
															<token-local-variable name="permValue"/>
														</arg-string>
													</do-append-xml-text>
												</arg-actions>
												<arg-actions>
													<do-append-xml-element expression="operation-data" name="permission"/>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="entitlement">
														<arg-string>
															<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
																<token-local-variable name="entitlementQualifiedDn"/>
															</token-parse-dn>
														</arg-string>
													</do-set-xml-attr>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="resource">
														<arg-string>
															<token-local-variable name="staticMappedGroupResource"/>
														</arg-string>
													</do-set-xml-attr>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="dynamic">
														<arg-string>
															<token-text xml:space="preserve">false</token-text>
														</arg-string>
													</do-set-xml-attr>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="name">
														<arg-string>
															<token-local-variable name="assignAttr"/>
														</arg-string>
													</do-set-xml-attr>
												</arg-actions>
											</do-if>
										</arg-actions>
										<arg-actions>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="assignAttr" op="equal">Login Disabled</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-if>
														<arg-conditions>
															<and>
																<if-local-variable mode="nocase" name="current-node" op="equal">false</if-local-variable>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-set-local-variable name="allowAccountGrant" scope="policy">
																<arg-string>
																	<token-text xml:space="preserve">true</token-text>
																</arg-string>
															</do-set-local-variable>
															<do-set-local-variable name="prevEntRef" scope="policy">
																<arg-node-set>
																	<token-query class-name="User" datastore="src" scope="entry">
																		<arg-dn>
																			<token-src-dn/>
																		</arg-dn>
																		<arg-string>
																			<token-text xml:space="preserve">DirXML-EntitlementRef</token-text>
																		</arg-string>
																	</token-query>
																</arg-node-set>
															</do-set-local-variable>
															<do-for-each>
																<arg-node-set>
																	<token-local-variable name="prevEntRef"/>
																</arg-node-set>
																<arg-actions>
																	<do-if>
																		<arg-conditions>
																			<and>
																				<if-xpath op="true">$current-node/attr/value[component[@name="volume"]/text()=$entitlementDN and component[@name="nameSpace"]/text()="1"]
</if-xpath>
																			</and>
																		</arg-conditions>
																		<arg-actions>
																			<do-set-local-variable name="allowAccountGrant" scope="policy">
																				<arg-string>
																					<token-text xml:space="preserve">false</token-text>
																				</arg-string>
																			</do-set-local-variable>
																		</arg-actions>
																		<arg-actions>
																			<do-set-local-variable name="allowAccountGrant" scope="policy">
																				<arg-string>
																					<token-text xml:space="preserve">true</token-text>
																				</arg-string>
																			</do-set-local-variable>
																		</arg-actions>
																	</do-if>
																</arg-actions>
															</do-for-each>
															<do-if>
																<arg-conditions>
																	<and>
																		<if-local-variable mode="nocase" name="allowAccountGrant" op="equal">true</if-local-variable>
																	</and>
																</arg-conditions>
																<arg-actions>
																	<do-append-xml-element expression="operation-data/permission[last()]" name="pvalue"/>
																	<do-append-xml-text expression="operation-data/permission[last()]/pvalue[last()]">
																		<arg-string>
																			<token-text xml:space="preserve">{"ID":"</token-text>
																			<token-global-variable name="drv.domain.dns.name"/>
																			<token-text xml:space="preserve">"}</token-text>
																		</arg-string>
																	</do-append-xml-text>
																</arg-actions>
																<arg-actions>
																	<do-strip-xpath expression="./operation-data/permission[last()]"/>
																</arg-actions>
															</do-if>
														</arg-actions>
														<arg-actions/>
													</do-if>
												</arg-actions>
												<arg-actions>
													<do-set-local-variable name="staticMappedResource" scope="policy">
														<arg-string>
															<token-map dest="staticResource" src="entitlementValue" table="..\StaticValueEntitlementMap">
																<token-local-variable name="current-node"/>
															</token-map>
														</arg-string>
													</do-set-local-variable>
													<do-if>
														<arg-conditions>
															<and>
																<if-local-variable mode="nocase" name="staticMappedResource" op="equal"/>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-append-xml-element expression="operation-data/permission[@dynamic='true'][last()]" name="pvalue"/>
															<do-append-xml-text expression="operation-data/permission[@dynamic='true'][last()]/pvalue[last()]">
																<arg-string>
																	<token-text xml:space="preserve">{"ID":"</token-text>
																	<token-local-variable name="current-node"/>
																	<token-text xml:space="preserve">"}</token-text>
																</arg-string>
															</do-append-xml-text>
														</arg-actions>
														<arg-actions>
															<do-append-xml-element expression="operation-data" name="permission"/>
															<do-set-xml-attr expression="operation-data/permission[last()]" name="entitlement">
																<arg-string>
																	<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
																		<token-local-variable name="entitlementQualifiedDn"/>
																	</token-parse-dn>
																</arg-string>
															</do-set-xml-attr>
															<do-set-xml-attr expression="operation-data/permission[last()]" name="resource">
																<arg-string>
																	<token-local-variable name="staticMappedResource"/>
																</arg-string>
															</do-set-xml-attr>
															<do-set-xml-attr expression="operation-data/permission[last()]" name="dynamic">
																<arg-string>
																	<token-text xml:space="preserve">false</token-text>
																</arg-string>
															</do-set-xml-attr>
															<do-set-xml-attr expression="operation-data/permission[last()]" name="name">
																<arg-string>
																	<token-local-variable name="assignAttr"/>
																</arg-string>
															</do-set-xml-attr>
														</arg-actions>
													</do-if>
												</arg-actions>
											</do-if>
										</arg-actions>
									</do-if>
								</arg-actions>
							</do-for-each>
							<do-strip-op-attr disabled="true" name="$current-node$"/>
						</arg-actions>
						<arg-actions>
							<do-set-local-variable name="addStaticValues" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">false</token-text>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="assignAttr" op="equal">Login Disabled</if-local-variable>
										<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="not-equal">true</if-global-variable>
									</and>
									<and>
										<if-local-variable mode="nocase" name="assignAttr" op="equal">Group Membership</if-local-variable>
										<if-global-variable mode="nocase" name="drv.entitlement.Group" op="not-equal">true</if-global-variable>
									</and>
									<and>
										<if-local-variable mode="nocase" name="assignAttr" op="equal">Mailbox ID</if-local-variable>
										<if-global-variable mode="nocase" name="drv.exchMailboxMethod" op="equal">disabled</if-global-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="addStaticValues" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">true</token-text>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-if>
										<arg-conditions>
											<and>
												<if-global-variable mode="nocase" name="drv.entitlement.onboarding.all" op="equal">true</if-global-variable>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="addStaticValues" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">true</token-text>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions>
											<do-for-each>
												<arg-node-set>
													<token-global-variable name="drv.entitlement.onboardEnt"/>
												</arg-node-set>
												<arg-actions>
													<do-set-local-variable name="givenAttr" scope="policy">
														<arg-string>
															<token-xpath expression='$current-node/definition[@name="drv.entitlement.entName"]/value/text()'/>
														</arg-string>
													</do-set-local-variable>
													<do-if>
														<arg-conditions>
															<and>
																<if-local-variable mode="nocase" name="givenAttr" op="equal">$assignAttr$</if-local-variable>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-set-local-variable name="addStaticValues" scope="policy">
																<arg-string>
																	<token-text xml:space="preserve">true</token-text>
																</arg-string>
															</do-set-local-variable>
														</arg-actions>
														<arg-actions/>
													</do-if>
												</arg-actions>
											</do-for-each>
										</arg-actions>
									</do-if>
								</arg-actions>
							</do-if>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="addStaticValues" op="equal">true</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="static-values" scope="policy">
										<arg-node-set>
											<token-attr name="$current-node$"/>
										</arg-node-set>
									</do-set-local-variable>
									<do-for-each>
										<arg-node-set>
											<token-local-variable name="static-values"/>
										</arg-node-set>
										<arg-actions>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="assignAttr" op="equal">Group Membership</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="groupName" scope="policy">
														<arg-string>
															<token-parse-dn dest-dn-format="ldap" length="-1" src-dn-format="slash" start="-1">
																<token-local-variable name="current-node"/>
															</token-parse-dn>
														</arg-string>
													</do-set-local-variable>
													<do-set-local-variable name="groupFQDN" scope="policy">
														<arg-string>
															<token-text xml:space="preserve">CN=</token-text>
															<token-local-variable name="groupName"/>
															<token-text xml:space="preserve">,</token-text>
															<token-xpath expression="es:convertLDAPtoUpper($drv.user.container)"/>
														</arg-string>
													</do-set-local-variable>
													<do-set-local-variable name="staticMappedUserResource" scope="policy">
														<arg-string>
															<token-map dest="staticResource" src="entitlementValue" table="..\StaticValueEntitlementMap">
																<token-local-variable name="groupFQDN"/>
															</token-map>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
												<arg-actions>
													<do-set-local-variable name="staticMappedUserResource" scope="policy">
														<arg-string>
															<token-map dest="staticResource" src="entitlementValue" table="..\StaticValueEntitlementMap">
																<token-local-variable name="current-node"/>
															</token-map>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
											</do-if>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="staticMappedUserResource" op="not-equal"/>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="entitlementDN" scope="policy">
														<arg-string>
															<token-map dest="entitlementDN" src="assignmentAttribute" table="..\PermissionEntMapping">
																<token-local-variable name="assignAttr"/>
															</token-map>
														</arg-string>
													</do-set-local-variable>
													<do-set-local-variable name="entitlementObj" scope="policy">
														<arg-node-set>
															<token-query class-name="DirXML-Entitlement" datastore="src" scope="entry">
																<arg-dn>
																	<token-local-variable name="entitlementDN"/>
																</arg-dn>
															</token-query>
														</arg-node-set>
													</do-set-local-variable>
													<do-set-local-variable name="entitlementQualifiedDn" scope="policy">
														<arg-string>
															<token-xpath expression="$entitlementObj/@qualified-src-dn"/>
														</arg-string>
													</do-set-local-variable>
													<do-append-xml-element expression="operation-data" name="permission"/>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="entitlement">
														<arg-string>
															<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
																<token-local-variable name="entitlementQualifiedDn"/>
															</token-parse-dn>
														</arg-string>
													</do-set-xml-attr>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="resource">
														<arg-string>
															<token-local-variable name="staticMappedUserResource"/>
														</arg-string>
													</do-set-xml-attr>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="dynamic">
														<arg-string>
															<token-text xml:space="preserve">false</token-text>
														</arg-string>
													</do-set-xml-attr>
													<do-set-xml-attr expression="operation-data/permission[last()]" name="name">
														<arg-string>
															<token-local-variable name="assignAttr"/>
														</arg-string>
													</do-set-xml-attr>
												</arg-actions>
												<arg-actions/>
											</do-if>
										</arg-actions>
									</do-for-each>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
					</do-if>
					<!--
						set local variable 'driverCN' with driver's CN
						-->
					<!-- 
						set local variable 'entitlementQualifiedDn' with the value of the 'qualified-src-dn
						attribute on the root node of 'entitlementObj'
						-->
				</arg-actions>
			</do-for-each>
			<do-if>
				<arg-conditions>
					<and>
						<if-xpath op="true">operation-data/permission</if-xpath>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="containerDN" scope="policy">
						<arg-string>
							<token-parse-dn dest-dn-format="slash" length="-2" src-dn-format="slash">
								<token-xpath expression="@src-dn"/>
							</token-parse-dn>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="userCN" scope="policy">
						<arg-string>
							<token-parse-dn dest-dn-format="ldap" length="-1" src-dn-format="slash" start="-1">
								<token-xpath expression="@src-dn"/>
							</token-parse-dn>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="containerObj" scope="policy">
						<arg-node-set>
							<token-query datastore="src" scope="entry">
								<arg-dn>
									<token-local-variable name="containerDN"/>
								</arg-dn>
							</token-query>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="userQualifiedLDAPDn" scope="policy">
						<arg-string>
							<token-text xml:space="preserve">CN=</token-text>
							<token-local-variable name="userCN"/>
							<token-text xml:space="preserve">,</token-text>
							<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
								<token-xpath expression="$containerObj/@qualified-src-dn"/>
							</token-parse-dn>
						</arg-string>
					</do-set-local-variable>
					<do-append-xml-element expression="operation-data" name="object-dn"/>
					<do-append-xml-text expression="operation-data/object-dn">
						<arg-string>
							<token-local-variable name="userQualifiedLDAPDn"/>
						</arg-string>
					</do-append-xml-text>
				</arg-actions>
				<arg-actions/>
			</do-if>
		</actions>
	</rule>
	<rule>
		<description>Add Group Multi-value User assignments to Operation Data</description>
		<conditions>
			<and>
				<if-class-name mode="nocase" op="equal">Group</if-class-name>
				<if-operation mode="regex" op="equal">add|modify</if-operation>
				<if-global-variable mode="nocase" name="drv.entitlement.Group" op="equal">false</if-global-variable>
				<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
				<if-global-variable mode="nocase" name="drv.entitlement.Group.onboard" op="equal">true</if-global-variable>
			</and>
		</conditions>
		<actions>
			<do-if>
				<arg-conditions>
					<and>
						<if-xpath op="not-true">operation-data</if-xpath>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-append-xml-element expression="." name="operation-data"/>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-append-xml-element expression="operation-data" name="entitlement-assignments"/>
			<do-set-local-variable name="entitlementObj" scope="policy">
				<arg-node-set>
					<token-query class-name="DirXML-Entitlement" datastore="src" scope="entry">
						<arg-dn>
							<token-global-variable name="dirxml.auto.driverdn"/>
							<token-text xml:space="preserve">\Group</token-text>
						</arg-dn>
					</token-query>
				</arg-node-set>
			</do-set-local-variable>
			<!--
			set local variable 'driverCN' with driver's CN
			-->
			<!-- 
			set local variable 'entitlementQualifiedDn' with the value of the 'qualified-src-dn
			attribute on the root node of 'entitlementObj'
			-->
			<do-set-local-variable name="entitlementQualifiedDn" scope="policy">
				<arg-string>
					<token-xpath expression="$entitlementObj/@qualified-src-dn"/>
				</arg-string>
			</do-set-local-variable>
			<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="entitlement">
				<arg-string>
					<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
						<token-local-variable name="entitlementQualifiedDn"/>
					</token-parse-dn>
				</arg-string>
			</do-set-xml-attr>
			<do-if>
				<arg-conditions>
					<and>
						<if-operation mode="regex" op="equal">modify</if-operation>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="querySrcDN" scope="policy">
						<arg-node-set>
							<token-query class-name="User" scope="entry">
								<arg-association>
									<token-association/>
								</arg-association>
							</token-query>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="groupFQDN" scope="policy">
						<arg-string>
							<token-xpath expression="$querySrcDN/@src-dn"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="value">
						<arg-string>
							<token-text xml:space="preserve">{"ID":"</token-text>
							<token-association/>
							<token-text xml:space="preserve">","ID2":"</token-text>
							<token-local-variable name="groupFQDN"/>
							<token-text xml:space="preserve">"}</token-text>
						</arg-string>
					</do-set-xml-attr>
				</arg-actions>
				<arg-actions>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="value">
						<arg-string>
							<token-text xml:space="preserve">{"ID":"","ID2":""}</token-text>
						</arg-string>
					</do-set-xml-attr>
				</arg-actions>
			</do-if>
			<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="value">
				<arg-string>
					<token-text xml:space="preserve">{"ID":"</token-text>
					<token-association/>
					<token-text xml:space="preserve">","ID2":"</token-text>
					<token-local-variable name="groupFQDN"/>
					<token-text xml:space="preserve">"}</token-text>
				</arg-string>
			</do-set-xml-attr>
			<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="fieldId">
				<arg-string>
					<token-text xml:space="preserve">ID2</token-text>
				</arg-string>
			</do-set-xml-attr>
			<do-set-local-variable name="staticMappedResource" scope="policy">
				<arg-string>
					<token-map dest="staticResource" src="entitlementValue" table="..\StaticValueEntitlementMap">
						<token-local-variable name="groupFQDN"/>
					</token-map>
				</arg-string>
			</do-set-local-variable>
			<do-if>
				<arg-conditions>
					<and>
						<if-local-variable mode="nocase" name="staticMappedResource" op="not-equal"/>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="resource">
						<arg-string>
							<token-local-variable name="staticMappedResource"/>
						</arg-string>
					</do-set-xml-attr>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="dynamic">
						<arg-string>
							<token-text xml:space="preserve">false</token-text>
						</arg-string>
					</do-set-xml-attr>
				</arg-actions>
				<arg-actions>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="resource">
						<arg-string>
							<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">Group</token-text>
							</token-map>
						</arg-string>
					</do-set-xml-attr>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="dynamic">
						<arg-string>
							<token-text xml:space="preserve">true</token-text>
						</arg-string>
					</do-set-xml-attr>
				</arg-actions>
			</do-if>
			<do-if>
				<arg-conditions>
					<and>
						<if-op-attr name="Member" op="changing"/>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="memberList" scope="policy">
						<arg-node-set>
							<token-src-attr name="Member"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-for-each>
						<arg-node-set>
							<token-local-variable name="memberList"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="holderObj" scope="policy">
								<arg-node-set>
									<token-query class-name="DirXML-Entitlement" datastore="src" scope="entry">
										<arg-dn>
											<token-local-variable name="current-node"/>
										</arg-dn>
									</token-query>
								</arg-node-set>
							</do-set-local-variable>
							<!--
			set local variable 'driverCN' with driver's CN
			-->
							<!-- 
			set local variable 'driverQualifiedDn' with the value of the 'qualified-src-dn
			attribute on the root node of 'driverObj'
			-->
							<do-set-local-variable name="holderQualifiedDn" scope="policy">
								<arg-string>
									<token-xpath expression="$holderObj/@qualified-src-dn"/>
								</arg-string>
							</do-set-local-variable>
							<do-append-xml-element expression="operation-data/entitlement-assignments[last()]" name="holder"/>
							<do-append-xml-text expression="operation-data/entitlement-assignments[last()]/holder[last()]">
								<arg-string>
									<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
										<token-local-variable name="holderQualifiedDn"/>
									</token-parse-dn>
								</arg-string>
							</do-append-xml-text>
						</arg-actions>
					</do-for-each>
					<do-strip-op-attr disabled="true" name="Member"/>
				</arg-actions>
				<arg-actions/>
			</do-if>
		</actions>
	</rule>
	<rule>
		<description>Remove ALL entitlements if AD account deleted</description>
		<conditions>
			<and>
				<if-operation mode="case" op="equal">delete</if-operation>
				<if-class-name mode="nocase" op="equal">User</if-class-name>
				<if-global-variable mode="nocase" name="drv.entitlement.UserAccount" op="equal">false</if-global-variable>
				<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
			</and>
		</conditions>
		<actions>
			<do-if>
				<arg-conditions>
					<and>
						<if-xpath op="not-true">operation-data</if-xpath>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-append-xml-element expression="." name="operation-data"/>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-set-local-variable name="perm-attrs" scope="policy">
				<arg-node-set>
					<token-xpath expression="$perm-map-xml/mapping-table/row/col[last()]/text()"/>
				</arg-node-set>
			</do-set-local-variable>
			<do-clone-xpath dest-expression="operation-data" src-expression="$static-map-xml"/>
			<do-for-each>
				<arg-node-set>
					<token-local-variable name="perm-attrs"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="permission-values" scope="policy">
						<arg-node-set>
							<token-op-attr name="$current-node$"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-append-xml-element expression="operation-data" name="permission"/>
					<do-set-local-variable name="assignAttr" scope="policy">
						<arg-string>
							<token-local-variable name="current-node"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-xml-attr expression="operation-data/permission[last()]" name="name">
						<arg-string>
							<token-local-variable name="assignAttr"/>
						</arg-string>
					</do-set-xml-attr>
					<do-set-local-variable name="entitlementDN" scope="policy">
						<arg-string>
							<token-map dest="entitlementDN" src="assignmentAttribute" table="..\PermissionEntMapping">
								<token-local-variable name="assignAttr"/>
							</token-map>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="entitlementObj" scope="policy">
						<arg-node-set>
							<token-query class-name="DirXML-Entitlement" datastore="src" scope="entry">
								<arg-dn>
									<token-local-variable name="entitlementDN"/>
								</arg-dn>
							</token-query>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="entitlementQualifiedDn" scope="policy">
						<arg-string>
							<token-xpath expression="$entitlementObj/@qualified-src-dn"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-xml-attr expression="operation-data/permission[last()]" name="entitlement">
						<arg-string>
							<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
								<token-local-variable name="entitlementQualifiedDn"/>
							</token-parse-dn>
						</arg-string>
					</do-set-xml-attr>
					<do-set-xml-attr expression="operation-data/permission[last()]" name="dynamicResource">
						<arg-string>
							<token-map dest="resourceDN" src="assignmentAttribute" table="..\PermissionEntMapping">
								<token-local-variable name="assignAttr"/>
							</token-map>
						</arg-string>
					</do-set-xml-attr>
					<do-strip-op-attr name="$current-node$"/>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
	<rule>
		<description>Remove ALL entitlements if AD group deleted</description>
		<conditions>
			<and>
				<if-class-name mode="nocase" op="equal">Group</if-class-name>
				<if-operation mode="nocase" op="equal">delete</if-operation>
				<if-global-variable mode="nocase" name="drv.entitlement.onboarding" op="equal">true</if-global-variable>
				<if-global-variable mode="nocase" name="drv.entitlement.Group.onboard" op="equal">true</if-global-variable>
			</and>
		</conditions>
		<actions>
			<do-if>
				<arg-conditions>
					<and>
						<if-xpath op="not-true">operation-data</if-xpath>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-append-xml-element expression="." name="operation-data"/>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-append-xml-element expression="operation-data" name="entitlement-assignments"/>
			<do-set-local-variable name="entitlementObj" scope="policy">
				<arg-node-set>
					<token-query class-name="DirXML-Entitlement" datastore="src" scope="entry">
						<arg-dn>
							<token-global-variable name="dirxml.auto.driverdn"/>
							<token-text xml:space="preserve">\Group</token-text>
						</arg-dn>
					</token-query>
				</arg-node-set>
			</do-set-local-variable>
			<!--
			set local variable 'driverCN' with driver's CN
			-->
			<!-- 
			set local variable 'entitlementQualifiedDn' with the value of the 'qualified-src-dn
			attribute on the root node of 'entitlementObj'
			-->
			<do-set-local-variable name="entitlementQualifiedDn" scope="policy">
				<arg-string>
					<token-xpath expression="$entitlementObj/@qualified-src-dn"/>
				</arg-string>
			</do-set-local-variable>
			<do-set-local-variable name="groupName" scope="policy">
				<arg-string>
					<token-parse-dn dest-dn-format="ldap" length="-1" src-dn-format="slash" start="-1">
						<token-src-dn/>
					</token-parse-dn>
				</arg-string>
			</do-set-local-variable>
			<do-set-local-variable name="groupFQDN" scope="policy">
				<arg-string>
					<token-text xml:space="preserve">CN=</token-text>
					<token-local-variable name="groupName"/>
					<token-text xml:space="preserve">,</token-text>
					<token-xpath expression="es:convertLDAPtoUpper($drv.user.container)"/>
				</arg-string>
			</do-set-local-variable>
			<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="entitlement">
				<arg-string>
					<token-parse-dn dest-dn-format="ldap" src-dn-format="qualified-slash">
						<token-local-variable name="entitlementQualifiedDn"/>
					</token-parse-dn>
				</arg-string>
			</do-set-xml-attr>
			<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="value">
				<arg-string>
					<token-text xml:space="preserve">{"ID":"</token-text>
					<token-association/>
					<token-text xml:space="preserve">","ID2":"</token-text>
					<token-local-variable name="groupFQDN"/>
					<token-text xml:space="preserve">"}</token-text>
				</arg-string>
			</do-set-xml-attr>
			<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="fieldId">
				<arg-string>
					<token-text xml:space="preserve">ID2</token-text>
				</arg-string>
			</do-set-xml-attr>
			<do-set-local-variable name="staticMappedResource" scope="policy">
				<arg-string>
					<token-map dest="staticResource" src="entitlementValue" table="..\StaticValueEntitlementMap">
						<token-local-variable name="groupFQDN"/>
					</token-map>
				</arg-string>
			</do-set-local-variable>
			<do-if>
				<arg-conditions>
					<and>
						<if-local-variable mode="nocase" name="staticMappedResource" op="not-equal"/>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="resource">
						<arg-string>
							<token-local-variable name="staticMappedResource"/>
						</arg-string>
					</do-set-xml-attr>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="dynamic">
						<arg-string>
							<token-text xml:space="preserve">false</token-text>
						</arg-string>
					</do-set-xml-attr>
				</arg-actions>
				<arg-actions>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="resource">
						<arg-string>
							<token-map dest="resourceDN" src="entitlementName" table="..\PermissionEntMapping">
								<token-text xml:space="preserve">Group</token-text>
							</token-map>
						</arg-string>
					</do-set-xml-attr>
					<do-set-xml-attr expression="operation-data/entitlement-assignments[last()]" name="dynamic">
						<arg-string>
							<token-text xml:space="preserve">true</token-text>
						</arg-string>
					</do-set-xml-attr>
				</arg-actions>
			</do-if>
		</actions>
	</rule>
</policy>