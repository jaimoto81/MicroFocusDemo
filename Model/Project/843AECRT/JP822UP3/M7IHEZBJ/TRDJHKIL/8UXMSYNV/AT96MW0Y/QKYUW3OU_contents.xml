<?xml version="1.0" encoding="UTF-8"?><policy xmlns:dq="http://www.novell.com/nxsl/java/com.novell.xml.dom.DOMQuery" xmlns:thread="http://www.novell.com/nxsl/java/java.lang.Thread">
	<rule>
		<description>AccountTracking - Initialize Realm Mapping</description>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.acctTrk.enable" op="equal">true</if-global-variable>
				<if-global-variable mode="nocase" name="drv.acctTrk.mode" op="equal">fanout</if-global-variable>
				<if-local-variable mode="nocase" name="realmMappingInitialized" op="not-equal">true</if-local-variable>
			</and>
		</conditions>
		<actions>
			<do-set-local-variable name="objectClass" scope="driver">
				<arg-string>
					<token-dest-attr name="Object Class">
						<arg-dn>
							<token-global-variable name="dirxml.auto.driverdn"/>
						</arg-dn>
					</token-dest-attr>
				</arg-string>
			</do-set-local-variable>
			<do-if>
				<arg-conditions>
					<and>
						<if-local-variable mode="regex" name="objectClass" op="equal">.+</if-local-variable>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-trace-message>
						<arg-string>
							<token-text xml:space="preserve">Account Tracking: Initializing realm mapping</token-text>
						</arg-string>
					</do-trace-message>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable name="shimConfigInfo" op="not-available"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="shimConfigInfo" scope="driver">
								<arg-node-set>
									<token-document>
										<arg-string>
											<token-text xml:space="preserve">vnd.nds.stream:</token-text>
											<token-text xml:space="preserve">/</token-text>
											<token-parse-dn dest-dn-delims="00,/+=*\" dest-dn-format="custom" src-dn-format="slash">
												<token-global-variable name="dirxml.auto.driverdn"/>
											</token-parse-dn>
											<token-text xml:space="preserve">#</token-text>
											<token-text xml:space="preserve">DirXML-ShimConfigInfo</token-text>
										</arg-string>
									</token-document>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-set-local-variable name="primSystemID" scope="policy">
						<arg-string>
							<token-xpath expression="$shimConfigInfo/driver-config/driver-options/configuration-values/definitions/definition[@name='nsap-system-id']/value"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="primSystemNumber" scope="policy">
						<arg-string>
							<token-xpath expression="$shimConfigInfo/driver-config/driver-options/configuration-values/definitions/definition[@name='nsap-cs-type']/value"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="primClientNumber" scope="policy">
						<arg-string>
							<token-xpath expression="$shimConfigInfo/driver-config/driver-options/configuration-values/definitions/definition[@name='nsap-user-client']/value"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="key" scope="policy">
						<arg-string>
							<token-xpath expression="$shimConfigInfo/driver-config/driver-options/configuration-values/definitions/definition[@name='nsap-ls-name']/value"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="realm" scope="policy">
						<arg-string>
							<token-text xml:space="preserve">\</token-text>
							<token-local-variable name="primSystemID"/>
							<token-text xml:space="preserve">\</token-text>
							<token-local-variable name="primSystemNumber"/>
							<token-text xml:space="preserve">\</token-text>
							<token-local-variable name="primClientNumber"/>
						</arg-string>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="regex" name="key" op="equal">.+</if-local-variable>
								<if-local-variable mode="regex" name="realm" op="equal">.+</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="dvn" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">$key$-realm</token-text>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="$dvn$" scope="driver">
								<arg-string>
									<token-text xml:space="preserve">$realm$</token-text>
								</arg-string>
							</do-set-local-variable>
							<do-trace-message>
								<arg-string>
									<token-text xml:space="preserve">$dvn$=</token-text>
									<token-local-variable name="$dvn$"/>
								</arg-string>
							</do-trace-message>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-for-each>
						<arg-node-set>
							<token-xpath expression="$shimConfigInfo/driver-config/subscriber-options/configuration-values/definitions/definition[@name='nsap-alt-conn-info']/value/instance"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="systemID" scope="policy">
								<arg-string>
									<token-xpath expression="$current-node/definition[@name='systemID']/value"/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="systemNumber" scope="policy">
								<arg-string>
									<token-xpath expression="$current-node/definition[@name='systemNumber']/value"/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="clientNumber" scope="policy">
								<arg-string>
									<token-xpath expression="$current-node/definition[@name='clientNumber']/value"/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="key" scope="policy">
								<arg-string>
									<token-xpath expression="$current-node/definition[@name='logicalSystemName']/value"/>
								</arg-string>
							</do-set-local-variable>
							<do-set-local-variable name="realm" scope="policy">
								<arg-string>
									<token-text xml:space="preserve">\</token-text>
									<token-local-variable name="systemID"/>
									<token-text xml:space="preserve">\</token-text>
									<token-local-variable name="systemNumber"/>
									<token-text xml:space="preserve">\</token-text>
									<token-local-variable name="clientNumber"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="regex" name="key" op="equal">.+</if-local-variable>
										<if-local-variable mode="regex" name="realm" op="equal">.+</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="dvn" scope="policy">
										<arg-string>
											<token-text xml:space="preserve">$key$-realm</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-set-local-variable name="$dvn$" scope="driver">
										<arg-string>
											<token-text xml:space="preserve">$realm$</token-text>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">$dvn$=</token-text>
											<token-local-variable name="$dvn$"/>
										</arg-string>
									</do-trace-message>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
					</do-for-each>
					<do-set-local-variable name="realmMappingInitialized" scope="driver">
						<arg-string>
							<token-text xml:space="preserve">true</token-text>
						</arg-string>
					</do-set-local-variable>
					<do-trace-message>
						<arg-string>
							<token-text xml:space="preserve">Account Tracking: Realm mapping initialized.</token-text>
						</arg-string>
					</do-trace-message>
				</arg-actions>
				<arg-actions/>
			</do-if>
		</actions>
	</rule>
	<rule>
		<description>AccountTracking - disregard if disabled</description>
		<conditions>
			<and>
				<if-global-variable mode="nocase" name="drv.acctTrk.enable" op="not-equal">true</if-global-variable>
			</and>
		</conditions>
		<actions>
			<do-break/>
		</actions>
	</rule>
	<rule>
		<description>AccountTracking - query DirXML-Accounts Attribute</description>
		<conditions>
			<and>
				<if-op-property name="AccountTracking-ObjectDN" op="available"/>
			</and>
		</conditions>
		<actions>
			<do-set-local-variable name="AccountIdentifiers" scope="policy">
				<arg-node-set>
					<token-dest-attr name="DirXML-Accounts">
						<arg-dn>
							<token-op-property name="AccountTracking-ObjectDN"/>
						</arg-dn>
					</token-dest-attr>
				</arg-node-set>
			</do-set-local-variable>
		</actions>
	</rule>
	<rule>
		<description>AccountTracking - remove Dirxml-Account values on regular delete operation or revoke</description>
		<conditions>
			<and>
				<if-operation mode="regex" op="equal">delete|remove-association</if-operation>
				<if-op-property name="AccountTracking-ObjectDN" op="available"/>
			</and>
			<and>
				<if-operation mode="nocase" op="equal">status</if-operation>
				<if-op-property name="AccountTracking-ObjectDN" op="available"/>
				<if-op-property mode="nocase" name="AccountTracking-Operation" op="equal">delete</if-op-property>
			</and>
			<and>
				<if-operation mode="case" op="equal">status</if-operation>
				<if-op-property name="AccountTracking-ObjectDN" op="available"/>
				<if-op-property name="accountAction" op="available"/>
				<if-op-property mode="nocase" name="accountAction" op="equal">accountDisableByEntitlementRevoke</if-op-property>
			</and>
		</conditions>
		<actions>
			<do-if>
				<arg-conditions>
					<and>
						<if-global-variable mode="nocase" name="drv.acctTrk.mode" op="equal">121</if-global-variable>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-set-local-variable name="realm" scope="policy">
						<arg-string>
							<token-global-variable name="drv.acctTrk.realm"/>
						</arg-string>
					</do-set-local-variable>
				</arg-actions>
				<arg-actions>
					<do-if>
						<arg-conditions>
							<and>
								<if-global-variable mode="nocase" name="drv.acctTrk.mode" op="equal">fanout</if-global-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-if>
								<arg-conditions>
									<and>
										<if-global-variable mode="nocase" name="drv.acctTrk.realmLookupKeySource" op="equal">association</if-global-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-if>
										<arg-conditions>
											<and>
												<if-op-property name="AccountTracking-association" op="available"/>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="realm-key" scope="policy">
												<arg-string>
													<token-replace-first regex="~drv.acctTrk.realmKeyExtractor~" replace-with="$1">
														<token-op-property name="AccountTracking-association"/>
													</token-replace-first>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions>
											<do-if>
												<arg-conditions>
													<and>
														<if-association op="available"/>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="realm-key" scope="policy">
														<arg-string>
															<token-replace-first regex="~drv.acctTrk.realmKeyExtractor~" replace-with="$1">
																<token-association/>
															</token-replace-first>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
												<arg-actions/>
											</do-if>
										</arg-actions>
									</do-if>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="regex" name="realm-key" op="equal">.+</if-local-variable>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="dvn" scope="policy">
												<arg-string>
													<token-text xml:space="preserve">$realm-key$-realm</token-text>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="realm" scope="policy">
												<arg-string>
													<token-local-variable name="$dvn$"/>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions>
											<do-trace-message>
												<arg-string>
													<token-text xml:space="preserve">Account Tracking: unable to detect realm for mapped operation "delete"</token-text>
												</arg-string>
											</do-trace-message>
										</arg-actions>
									</do-if>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-if>
			<do-trace-message>
				<arg-string>
					<token-text xml:space="preserve">Account Tracking - Operation for realm "$realm$"</token-text>
				</arg-string>
			</do-trace-message>
			<do-for-each>
				<arg-node-set>
					<token-xpath expression="$AccountIdentifiers[starts-with(.,$dirxml.auto.driverguid) and contains(concat(.,'#'),concat('#',$realm,'#'))]"/>
				</arg-node-set>
				<arg-actions>
					<do-trace-message>
						<arg-string>
							<token-text xml:space="preserve">Account Tracking - Removing account tracking entry "$current-node$" from </token-text>
							<token-op-property name="AccountTracking-ObjectDN"/>
						</arg-string>
					</do-trace-message>
					<do-remove-dest-attr-value direct="true" name="DirXML-Accounts">
						<arg-dn>
							<token-op-property name="AccountTracking-ObjectDN"/>
						</arg-dn>
						<arg-value>
							<token-local-variable name="current-node"/>
						</arg-value>
					</do-remove-dest-attr-value>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
	<rule>
		<description>AccountTracking - update DirXMLAccounts attribute on regular operations</description>
		<conditions>
			<and>
				<if-op-property name="AccountTracking-Operation" op="not-available"/>
				<if-op-property name="AccountTracking-ObjectDN" op="available"/>
				<if-op-property name="AccountTracking-IdvAccountStatus" op="available"/>
				<if-op-property name="AccountTracking-AppAccountStatus" op="available"/>
				<if-operation mode="regex" op="not-equal">delete|remove-association</if-operation>
				<if-op-property mode="nocase" name="accountAction" op="not-equal">accountDisableByEntitlementRevoke</if-op-property>
			</and>
			<and>
				<if-operation mode="nocase" op="equal">status</if-operation>
				<if-xpath op="true">./@level='success' or ./@level='warning'</if-xpath>
				<if-op-property name="AccountTracking-Operation" op="available"/>
				<if-op-property mode="nocase" name="AccountTracking-Operation" op="not-equal">delete</if-op-property>
				<if-op-property name="AccountTracking-ObjectDN" op="available"/>
				<if-op-property name="AccountTracking-IdvAccountStatus" op="available"/>
				<if-op-property name="AccountTracking-AppAccountStatus" op="available"/>
				<if-op-property mode="nocase" name="accountAction" op="not-equal">accountDisableByEntitlementRevoke</if-op-property>
			</and>
		</conditions>
		<actions>
			<do-if>
				<arg-conditions>
					<and>
						<if-xpath op="not-true">$AccountIdentifiers</if-xpath>
					</and>
				</arg-conditions>
				<arg-actions>
					<do-add-dest-attr-value direct="true" name="Object Class">
						<arg-dn>
							<token-op-property name="AccountTracking-ObjectDN"/>
						</arg-dn>
						<arg-value>
							<token-text xml:space="preserve">DirXML-Identity</token-text>
						</arg-value>
					</do-add-dest-attr-value>
				</arg-actions>
				<arg-actions/>
			</do-if>
			<do-for-each>
				<arg-node-set>
					<token-global-variable name="drv.acctTrk.identifiers"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="var-idvStatus" scope="policy">
						<arg-string>
							<token-op-property name="AccountTracking-IdvAccountStatus"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="var-appStatus" scope="policy">
						<arg-string>
							<token-op-property name="AccountTracking-AppAccountStatus"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="search-key" scope="policy">
						<arg-string>
							<token-join delimiter="#">
								<token-global-variable name="dirxml.auto.driverguid"/>
								<token-local-variable name="current-node"/>
							</token-join>
						</arg-string>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-global-variable mode="nocase" name="drv.acctTrk.mode" op="equal">121</if-global-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="realm" scope="policy">
								<arg-string>
									<token-global-variable name="drv.acctTrk.realm"/>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions>
							<do-if>
								<arg-conditions>
									<and>
										<if-global-variable mode="nocase" name="drv.acctTrk.mode" op="equal">fanout</if-global-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-if>
										<arg-conditions>
											<and>
												<if-global-variable mode="nocase" name="drv.acctTrk.realmLookupKeySource" op="equal">association</if-global-variable>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-if>
												<arg-conditions>
													<and>
														<if-op-property name="AccountTracking-association" op="available"/>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="realm-key" scope="policy">
														<arg-string>
															<token-replace-first regex="~drv.acctTrk.realmKeyExtractor~" replace-with="$1">
																<token-op-property name="AccountTracking-association"/>
															</token-replace-first>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
												<arg-actions>
													<do-if>
														<arg-conditions>
															<and>
																<if-association op="available"/>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-set-local-variable name="realm-key" scope="policy">
																<arg-string>
																	<token-replace-first regex="~drv.acctTrk.realmKeyExtractor~" replace-with="$1">
																		<token-association/>
																	</token-replace-first>
																</arg-string>
															</do-set-local-variable>
														</arg-actions>
														<arg-actions/>
													</do-if>
												</arg-actions>
											</do-if>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="regex" name="realm-key" op="equal">.+</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="dvn" scope="policy">
														<arg-string>
															<token-text xml:space="preserve">$realm-key$-realm</token-text>
														</arg-string>
													</do-set-local-variable>
													<do-set-local-variable name="realm" scope="policy">
														<arg-string>
															<token-local-variable name="$dvn$"/>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
												<arg-actions>
													<do-trace-message>
														<arg-string>
															<token-text xml:space="preserve">Account Tracking: unable to detect realm for mapped operation</token-text>
														</arg-string>
													</do-trace-message>
												</arg-actions>
											</do-if>
										</arg-actions>
										<arg-actions/>
									</do-if>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
					</do-if>
					<do-set-local-variable name="var-accountElements" scope="policy">
						<arg-node-set/>
					</do-set-local-variable>
					<do-for-each>
						<arg-node-set>
							<token-xpath expression="$AccountIdentifiers[starts-with(.,$search-key) and contains(concat(.,'#'),concat('#',$realm,'#'))]"/>
						</arg-node-set>
						<arg-actions>
							<do-set-local-variable name="var-accountElements" scope="policy">
								<arg-node-set>
									<token-split delimiter="#">
										<token-local-variable name="current-node"/>
									</token-split>
								</arg-node-set>
							</do-set-local-variable>
						</arg-actions>
					</do-for-each>
					<do-if>
						<arg-conditions>
							<and>
								<if-xpath op="true">$AccountIdentifiers</if-xpath>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-if>
								<arg-conditions>
									<and>
										<if-xpath op="true">count($var-accountElements)>1</if-xpath>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-if>
										<arg-conditions>
											<and>
												<if-op-property mode="nocase" name="AccountTracking-IdvAccountStatus" op="equal">-</if-op-property>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="var-idvStatus" scope="policy">
												<arg-string>
													<token-xpath expression="$var-accountElements[4]"/>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions/>
									</do-if>
									<do-if>
										<arg-conditions>
											<and>
												<if-op-property mode="nocase" name="AccountTracking-AppAccountStatus" op="equal">-</if-op-property>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="var-appStatus" scope="policy">
												<arg-string>
													<token-xpath expression="$var-accountElements[5]"/>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions/>
									</do-if>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-op-property name="AccountTracking-$current-node$" op="available"/>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-trace-message>
								<arg-string>
									<token-text xml:space="preserve">Account Tracking - Account identifier "$current-node$" changed</token-text>
								</arg-string>
							</do-trace-message>
							<do-set-local-variable name="search-key" scope="policy">
								<arg-string>
									<token-join delimiter="#">
										<token-global-variable name="dirxml.auto.driverguid"/>
										<token-local-variable name="current-node"/>
									</token-join>
								</arg-string>
							</do-set-local-variable>
							<do-trace-message>
								<arg-string>
									<token-text xml:space="preserve">Account Tracking - Preparing to update entries with search-key "$search-key$" and realm "$realm$"</token-text>
								</arg-string>
							</do-trace-message>
							<do-for-each>
								<arg-node-set>
									<token-xpath expression="$AccountIdentifiers[starts-with(.,$search-key) and contains(concat(.,'#'),concat('#',$realm,'#'))]"/>
								</arg-node-set>
								<arg-actions>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Account Tracking - Removing entry "$current-node$"</token-text>
										</arg-string>
									</do-trace-message>
									<do-remove-dest-attr-value direct="true" name="DirXML-Accounts">
										<arg-dn>
											<token-op-property name="AccountTracking-ObjectDN"/>
										</arg-dn>
										<arg-value>
											<token-local-variable name="current-node"/>
										</arg-value>
									</do-remove-dest-attr-value>
								</arg-actions>
							</do-for-each>
							<do-set-local-variable name="tmp" scope="policy">
								<arg-string>
									<token-op-property name="AccountTracking-$current-node$"/>
								</arg-string>
							</do-set-local-variable>
							<do-if>
								<arg-conditions>
									<and>
										<if-xpath op="true">string-length($tmp) > 0</if-xpath>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="tmp" scope="policy">
										<arg-string>
											<token-join delimiter="#">
												<token-global-variable name="dirxml.auto.driverguid"/>
												<token-local-variable name="current-node"/>
												<token-op-property name="AccountTracking-$current-node$"/>
												<token-local-variable name="var-idvStatus"/>
												<token-local-variable name="var-appStatus"/>
												<token-local-variable name="realm"/>
											</token-join>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Account Tracking - Adding entry "$tmp$"</token-text>
										</arg-string>
									</do-trace-message>
									<do-add-dest-attr-value direct="true" name="DirXML-Accounts">
										<arg-dn>
											<token-op-property name="AccountTracking-ObjectDN"/>
										</arg-dn>
										<arg-value>
											<token-local-variable name="tmp"/>
										</arg-value>
									</do-add-dest-attr-value>
								</arg-actions>
								<arg-actions/>
							</do-if>
							<do-if>
								<arg-conditions>
									<and>
										<if-local-variable mode="nocase" name="current-node" op="not-equal">association</if-local-variable>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-clear-op-property name="AccountTracking-$current-node$"/>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
						<arg-actions>
							<do-if>
								<arg-conditions>
									<and>
										<if-op-property mode="nocase" name="AccountTracking-AccountStatusChanged" op="equal">true</if-op-property>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Account Tracking - Account status changed: IDV=$var-idvStatus$, APP=$var-appStatus$. Update existing entries.</token-text>
										</arg-string>
									</do-trace-message>
									<do-set-local-variable name="search-key" scope="policy">
										<arg-string>
											<token-join delimiter="#">
												<token-global-variable name="dirxml.auto.driverguid"/>
												<token-local-variable name="current-node"/>
											</token-join>
										</arg-string>
									</do-set-local-variable>
									<do-for-each>
										<arg-node-set>
											<token-xpath expression="$AccountIdentifiers[starts-with(.,$search-key) and contains(concat(.,'#'),concat('#',$realm,'#'))]"/>
										</arg-node-set>
										<arg-actions>
											<do-set-local-variable name="var-accountElements" scope="policy">
												<arg-node-set>
													<token-split delimiter="#">
														<token-local-variable name="current-node"/>
													</token-split>
												</arg-node-set>
											</do-set-local-variable>
											<do-trace-message>
												<arg-string>
													<token-text xml:space="preserve">Account Tracking - Removing entry "$current-node$"</token-text>
												</arg-string>
											</do-trace-message>
											<do-remove-dest-attr-value direct="true" name="DirXML-Accounts">
												<arg-dn>
													<token-op-property name="AccountTracking-ObjectDN"/>
												</arg-dn>
												<arg-value>
													<token-local-variable name="current-node"/>
												</arg-value>
											</do-remove-dest-attr-value>
										</arg-actions>
									</do-for-each>
									<do-if>
										<arg-conditions>
											<and>
												<if-xpath op="true">count($var-accountElements)>1</if-xpath>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="tmp" scope="policy">
												<arg-string>
													<token-join delimiter="#">
														<token-global-variable name="dirxml.auto.driverguid"/>
														<token-local-variable name="current-node"/>
														<token-xpath expression="$var-accountElements[3]"/>
														<token-local-variable name="var-idvStatus"/>
														<token-local-variable name="var-appStatus"/>
														<token-local-variable name="realm"/>
													</token-join>
												</arg-string>
											</do-set-local-variable>
											<do-trace-message>
												<arg-string>
													<token-text xml:space="preserve">Account Tracking - Adding entry "$tmp$"</token-text>
												</arg-string>
											</do-trace-message>
											<do-add-dest-attr-value direct="true" name="DirXML-Accounts">
												<arg-dn>
													<token-op-property name="AccountTracking-ObjectDN"/>
												</arg-dn>
												<arg-value>
													<token-local-variable name="tmp"/>
												</arg-value>
											</do-add-dest-attr-value>
										</arg-actions>
										<arg-actions>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="current-node" op="equal">association</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="idvObject" scope="policy">
														<arg-node-set>
															<token-query scope="entry">
																<arg-dn>
																	<token-op-property name="AccountTracking-ObjectDN"/>
																</arg-dn>
																<arg-string>
																	<token-text xml:space="preserve">Object Class</token-text>
																</arg-string>
															</token-query>
														</arg-node-set>
													</do-set-local-variable>
													<do-if>
														<arg-conditions>
															<and>
																<if-xpath op="not-true">string-length($idvObject/association)=0</if-xpath>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-set-local-variable name="tmp" scope="policy">
																<arg-string>
																	<token-join delimiter="#">
																		<token-global-variable name="dirxml.auto.driverguid"/>
																		<token-local-variable name="current-node"/>
																		<token-xpath expression="$idvObject/association"/>
																		<token-local-variable name="var-idvStatus"/>
																		<token-local-variable name="var-appStatus"/>
																		<token-local-variable name="realm"/>
																	</token-join>
																</arg-string>
															</do-set-local-variable>
															<do-trace-message>
																<arg-string>
																	<token-text xml:space="preserve">Account Tracking - New entry for account identifier "$current-node$": $tmp$</token-text>
																</arg-string>
															</do-trace-message>
															<do-add-dest-attr-value direct="true" name="DirXML-Accounts">
																<arg-dn>
																	<token-op-property name="AccountTracking-ObjectDN"/>
																</arg-dn>
																<arg-value>
																	<token-local-variable name="tmp"/>
																</arg-value>
															</do-add-dest-attr-value>
														</arg-actions>
														<arg-actions/>
													</do-if>
												</arg-actions>
												<arg-actions>
													<do-if>
														<arg-conditions>
															<and>
																<if-local-variable mode="nocase" name="current-node" op="equal">LDAPDN</if-local-variable>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-set-local-variable name="idvObject" scope="policy">
																<arg-node-set>
																	<token-query scope="entry">
																		<arg-dn>
																			<token-op-property name="AccountTracking-ObjectDN"/>
																		</arg-dn>
																		<arg-string>
																			<token-text xml:space="preserve">Object Class</token-text>
																		</arg-string>
																	</token-query>
																</arg-node-set>
															</do-set-local-variable>
															<do-if>
																<arg-conditions>
																	<and>
																		<if-xpath op="not-true">string-length($idvObject/association)=0</if-xpath>
																	</and>
																</arg-conditions>
																<arg-actions>
																	<do-set-local-variable name="appObject" scope="policy">
																		<arg-node-set>
																			<token-query datastore="src" scope="entry">
																				<arg-association>
																					<token-xpath expression="$idvObject/association"/>
																				</arg-association>
																			</token-query>
																		</arg-node-set>
																	</do-set-local-variable>
																	<do-if>
																		<arg-conditions>
																			<and>
																				<if-xpath op="not-true">string-length($appObject/@src-dn)=0</if-xpath>
																			</and>
																		</arg-conditions>
																		<arg-actions>
																			<do-set-local-variable name="tmp" scope="policy">
																				<arg-string>
																					<token-join delimiter="#">
																						<token-global-variable name="dirxml.auto.driverguid"/>
																						<token-local-variable name="current-node"/>
																						<token-xpath expression="$appObject/@src-dn"/>
																						<token-local-variable name="var-idvStatus"/>
																						<token-local-variable name="var-appStatus"/>
																						<token-local-variable name="realm"/>
																					</token-join>
																				</arg-string>
																			</do-set-local-variable>
																			<do-trace-message>
																				<arg-string>
																					<token-text xml:space="preserve">Account Tracking - New entry for account identifier "$current-node$": $tmp$</token-text>
																				</arg-string>
																			</do-trace-message>
																			<do-add-dest-attr-value direct="true" name="DirXML-Accounts">
																				<arg-dn>
																					<token-op-property name="AccountTracking-ObjectDN"/>
																				</arg-dn>
																				<arg-value>
																					<token-local-variable name="tmp"/>
																				</arg-value>
																			</do-add-dest-attr-value>
																		</arg-actions>
																		<arg-actions/>
																	</do-if>
																</arg-actions>
																<arg-actions/>
															</do-if>
														</arg-actions>
														<arg-actions>
															<do-set-local-variable name="idvObject" scope="policy">
																<arg-node-set>
																	<token-query scope="entry">
																		<arg-dn>
																			<token-op-property name="AccountTracking-ObjectDN"/>
																		</arg-dn>
																		<arg-string>
																			<token-text xml:space="preserve">Object Class</token-text>
																		</arg-string>
																	</token-query>
																</arg-node-set>
															</do-set-local-variable>
															<do-if>
																<arg-conditions>
																	<and>
																		<if-xpath op="not-true">string-length($idvObject/association)=0</if-xpath>
																	</and>
																</arg-conditions>
																<arg-actions>
																	<do-set-local-variable name="appObject" scope="policy">
																		<arg-node-set>
																			<token-query datastore="src" scope="entry">
																				<arg-association>
																					<token-xpath expression="$idvObject/association"/>
																				</arg-association>
																				<arg-string>
																					<token-local-variable name="current-node"/>
																				</arg-string>
																			</token-query>
																		</arg-node-set>
																	</do-set-local-variable>
																	<do-if>
																		<arg-conditions>
																			<and>
																				<if-xpath op="not-true">string-length($appObject/attr[@attr-name=$current-node])=0</if-xpath>
																			</and>
																		</arg-conditions>
																		<arg-actions>
																			<do-set-local-variable name="tmp" scope="policy">
																				<arg-string>
																					<token-join delimiter="#">
																						<token-global-variable name="dirxml.auto.driverguid"/>
																						<token-local-variable name="current-node"/>
																						<token-xpath expression="$appObject/attr[@attr-name=$current-node]"/>
																						<token-local-variable name="var-idvStatus"/>
																						<token-local-variable name="var-appStatus"/>
																						<token-local-variable name="realm"/>
																					</token-join>
																				</arg-string>
																			</do-set-local-variable>
																			<do-trace-message>
																				<arg-string>
																					<token-text xml:space="preserve">Account Tracking - New entry for account identifier "$current-node$": $tmp$</token-text>
																				</arg-string>
																			</do-trace-message>
																			<do-add-dest-attr-value direct="true" name="DirXML-Accounts">
																				<arg-dn>
																					<token-op-property name="AccountTracking-ObjectDN"/>
																				</arg-dn>
																				<arg-value>
																					<token-local-variable name="tmp"/>
																				</arg-value>
																			</do-add-dest-attr-value>
																		</arg-actions>
																		<arg-actions/>
																	</do-if>
																</arg-actions>
																<arg-actions/>
															</do-if>
														</arg-actions>
													</do-if>
												</arg-actions>
											</do-if>
										</arg-actions>
									</do-if>
								</arg-actions>
								<arg-actions/>
							</do-if>
						</arg-actions>
					</do-if>
				</arg-actions>
			</do-for-each>
			<do-clear-op-property name="AccountTracking-ObjectDN"/>
			<do-clear-op-property name="AccountTracking-IdvAccountStatus"/>
			<do-clear-op-property name="AccountTracking-AppAccountStatus"/>
			<do-clear-op-property name="AccountTracking-AccountStatusChanged"/>
		</actions>
	</rule>
	<rule>
		<description>AccountTracking - update DirXMLAccounts attribute on mapped operations</description>
		<conditions>
			<and>
				<if-xpath op="true">operation-data/account-tracking-operation</if-xpath>
				<if-operation mode="case" op="equal">status</if-operation>
				<if-xpath op="true">./@level='success' or ./@level='warning'</if-xpath>
				<if-op-property mode="nocase" name="accountAction" op="not-equal">accountDisableByEntitlementRevoke</if-op-property>
			</and>
			<and>
				<if-xpath op="true">operation-data/account-tracking-operation</if-xpath>
				<if-operation mode="case" op="equal">add-association</if-operation>
				<if-op-property mode="nocase" name="accountAction" op="not-equal">accountDisableByEntitlementRevoke</if-op-property>
			</and>
		</conditions>
		<actions>
			<do-for-each>
				<arg-node-set>
					<token-xpath expression="./operation-data/account-tracking-operation"/>
				</arg-node-set>
				<arg-actions>
					<do-set-local-variable name="atoNode" scope="policy">
						<arg-node-set>
							<token-local-variable name="current-node"/>
						</arg-node-set>
					</do-set-local-variable>
					<do-set-local-variable name="operation" scope="policy">
						<arg-string>
							<token-xpath expression="$current-node/@AccountTracking-Operation"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="realm" scope="policy">
						<arg-string>
							<token-xpath expression="$current-node/@AccountTracking-Realm"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="className" scope="policy">
						<arg-string>
							<token-xpath expression="$current-node/@AccountTracking-ClassName"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="idvAccountStatus" scope="policy">
						<arg-string>
							<token-xpath expression="$current-node/@AccountTracking-IdvAccountStatus"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="appAccountStatus" scope="policy">
						<arg-string>
							<token-xpath expression="$current-node/@AccountTracking-AppAccountStatus"/>
						</arg-string>
					</do-set-local-variable>
					<do-trace-message>
						<arg-string>
							<token-text xml:space="preserve">Account Tracking - Mapped $operation$ operation</token-text>
						</arg-string>
					</do-trace-message>
					<do-if>
						<arg-conditions>
							<and>
								<if-xpath op="true">$current-node/@AccountTracking-association</if-xpath>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-set-local-variable name="association" scope="policy">
								<arg-string>
									<token-xpath expression="$current-node/@AccountTracking-association"/>
								</arg-string>
							</do-set-local-variable>
						</arg-actions>
						<arg-actions>
							<do-if>
								<arg-conditions>
									<and>
										<if-operation mode="case" op="equal">add-association</if-operation>
										<if-xpath op="true">$current-node/@AccountTracking-RealmKey</if-xpath>
									</and>
								</arg-conditions>
								<arg-actions>
									<do-set-local-variable name="realm-key" scope="policy">
										<arg-string>
											<token-replace-first regex="~drv.acctTrk.realmKeyExtractor~" replace-with="$1">
												<token-xpath expression="text()"/>
											</token-replace-first>
										</arg-string>
									</do-set-local-variable>
									<do-set-local-variable name="new-realm-key" scope="policy">
										<arg-string>
											<token-xpath expression="$current-node/@AccountTracking-RealmKey"/>
										</arg-string>
									</do-set-local-variable>
									<do-set-local-variable name="association" scope="policy">
										<arg-string>
											<token-replace-first regex="$realm-key$" replace-with="$new-realm-key$">
												<token-xpath expression="text()"/>
											</token-replace-first>
										</arg-string>
									</do-set-local-variable>
								</arg-actions>
								<arg-actions>
									<do-break/>
								</arg-actions>
							</do-if>
						</arg-actions>
					</do-if>
					<do-set-local-variable name="dn" scope="policy">
						<arg-string>
							<token-xpath expression="$current-node/@AccountTracking-ObjectDN"/>
						</arg-string>
					</do-set-local-variable>
					<do-set-local-variable name="AccountIdentifiers" scope="policy">
						<arg-node-set>
							<token-dest-attr name="DirXML-Accounts">
								<arg-dn>
									<token-local-variable name="dn"/>
								</arg-dn>
							</token-dest-attr>
						</arg-node-set>
					</do-set-local-variable>
					<do-if>
						<arg-conditions>
							<and>
								<if-xpath op="not-true">$AccountIdentifiers</if-xpath>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-add-dest-attr-value direct="true" name="Object Class">
								<arg-dn>
									<token-local-variable name="dn"/>
								</arg-dn>
								<arg-value>
									<token-text xml:space="preserve">DirXML-Identity</token-text>
								</arg-value>
							</do-add-dest-attr-value>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="regex" name="operation" op="equal">add|enable|disable|delete</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-for-each>
								<arg-node-set>
									<token-xpath expression="$AccountIdentifiers[starts-with(.,$dirxml.auto.driverguid) and contains(concat(.,'#'),concat('#',$realm,'#'))]"/>
								</arg-node-set>
								<arg-actions>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Account Tracking - Removing entry $current-node$</token-text>
										</arg-string>
									</do-trace-message>
									<do-remove-dest-attr-value direct="true" name="DirXML-Accounts">
										<arg-dn>
											<token-local-variable name="dn"/>
										</arg-dn>
										<arg-value>
											<token-local-variable name="current-node"/>
										</arg-value>
									</do-remove-dest-attr-value>
								</arg-actions>
							</do-for-each>
						</arg-actions>
						<arg-actions/>
					</do-if>
					<do-if>
						<arg-conditions>
							<and>
								<if-local-variable mode="regex" name="operation" op="equal">add|enable|disable</if-local-variable>
							</and>
						</arg-conditions>
						<arg-actions>
							<do-for-each>
								<arg-node-set>
									<token-global-variable name="drv.acctTrk.identifiers"/>
								</arg-node-set>
								<arg-actions>
									<do-if>
										<arg-conditions>
											<and>
												<if-local-variable mode="nocase" name="current-node" op="equal">LDAPDN</if-local-variable>
											</and>
										</arg-conditions>
										<arg-actions>
											<do-set-local-variable name="sleep" scope="policy">
												<arg-string>
													<token-xpath expression="thread:sleep(number(~drv.acctTrk.fanout.som.repWaitTime~)*1000)"/>
												</arg-string>
											</do-set-local-variable>
											<do-set-local-variable name="instance" scope="policy">
												<arg-node-set>
													<token-query datastore="src">
														<arg-association>
															<token-local-variable name="association"/>
														</arg-association>
													</token-query>
												</arg-node-set>
											</do-set-local-variable>
											<do-set-local-variable name="value" scope="policy">
												<arg-string>
													<token-xpath expression="$instance/@src-dn"/>
												</arg-string>
											</do-set-local-variable>
										</arg-actions>
										<arg-actions>
											<do-if>
												<arg-conditions>
													<and>
														<if-local-variable mode="nocase" name="current-node" op="equal">DESTNAME</if-local-variable>
													</and>
												</arg-conditions>
												<arg-actions>
													<do-set-local-variable name="sleep" scope="policy">
														<arg-string>
															<token-xpath expression="thread:sleep(number(~drv.acctTrk.fanout.som.repWaitTime~)*1000)"/>
														</arg-string>
													</do-set-local-variable>
													<do-set-local-variable name="instance" scope="policy">
														<arg-node-set>
															<token-query datastore="src">
																<arg-association>
																	<token-local-variable name="association"/>
																</arg-association>
															</token-query>
														</arg-node-set>
													</do-set-local-variable>
													<do-set-local-variable name="value" scope="policy">
														<arg-string>
															<token-parse-dn dest-dn-format="src-dn" length="1" src-dn-format="src-dn" start="-1">
																<token-xpath expression="$instance/@src-dn"/>
															</token-parse-dn>
														</arg-string>
													</do-set-local-variable>
												</arg-actions>
												<arg-actions>
													<do-if>
														<arg-conditions>
															<and>
																<if-local-variable mode="nocase" name="current-node" op="equal">association</if-local-variable>
															</and>
														</arg-conditions>
														<arg-actions>
															<do-set-local-variable name="value" scope="policy">
																<arg-string>
																	<token-local-variable name="association"/>
																</arg-string>
															</do-set-local-variable>
														</arg-actions>
														<arg-actions>
															<do-set-local-variable name="sleep" scope="policy">
																<arg-string>
																	<token-xpath expression="thread:sleep(number(~drv.acctTrk.fanout.som.repWaitTime~)*1000)"/>
																</arg-string>
															</do-set-local-variable>
															<do-set-local-variable name="value" scope="policy">
																<arg-string>
																	<token-src-attr name="$current-node$">
																		<arg-association>
																			<token-local-variable name="association"/>
																		</arg-association>
																	</token-src-attr>
																</arg-string>
															</do-set-local-variable>
														</arg-actions>
													</do-if>
												</arg-actions>
											</do-if>
										</arg-actions>
									</do-if>
									<do-set-local-variable name="tmp" scope="policy">
										<arg-string>
											<token-join delimiter="#">
												<token-global-variable name="dirxml.auto.driverguid"/>
												<token-local-variable name="current-node"/>
												<token-local-variable name="value"/>
												<token-local-variable name="idvAccountStatus"/>
												<token-local-variable name="appAccountStatus"/>
												<token-local-variable name="realm"/>
											</token-join>
										</arg-string>
									</do-set-local-variable>
									<do-trace-message>
										<arg-string>
											<token-text xml:space="preserve">Account Tracking - Adding entry $tmp$</token-text>
										</arg-string>
									</do-trace-message>
									<do-add-dest-attr-value direct="true" name="DirXML-Accounts">
										<arg-dn>
											<token-local-variable name="dn"/>
										</arg-dn>
										<arg-value>
											<token-local-variable name="tmp"/>
										</arg-value>
									</do-add-dest-attr-value>
								</arg-actions>
							</do-for-each>
						</arg-actions>
						<arg-actions/>
					</do-if>
				</arg-actions>
			</do-for-each>
		</actions>
	</rule>
</policy>